<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å¿ƒå•æ®å¤„ç†ç³»ç»Ÿ</title>
    
    <!-- å¤–éƒ¨ä¾èµ– -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- CSS æ¨¡å— -->
    <link rel="stylesheet" href="styles/base.css?v=15">
    <link rel="stylesheet" href="styles/layout.css?v=16">
    <link rel="stylesheet" href="styles/steps.css?v=16">
    <link rel="stylesheet" href="styles/panels.css?v=15">
    <link rel="stylesheet" href="styles/components.css?v=18">
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ä¸­å¿ƒå•æ®å¤„ç†ç³»ç»Ÿ</h1>
            <p>æ”¯æ’‘ä¸šåŠ¡å•æ®éç»“æ„åŒ–ä¿¡æ¯å‘ç»“æ„åŒ–ä¸šåŠ¡æ•°æ®è½¬åŒ–çš„å¤„ç†å¹³å°</p>
        </div>
        
        <!-- æµç¨‹è¿›åº¦æ¡ -->
        <div class="workflow-container">
            <div class="workflow-progress">
                <div class="workflow-steps" id="workflowSteps">
                    <!-- å•æ®è®¾å®šæŒ‰é’® -->
                    <button class="toolbar-btn toolbar-btn-config" id="toolbarDocTypeBtn" title="å•æ®è®¾å®š">
                        âš™ï¸ å•æ®è®¾å®š
                    </button>
                    
                    <div class="workflow-step" id="step1" data-step="1">
                        <div class="step-icon">1</div>
                        <div class="step-label">æ¨¡å‹åŠ è½½</div>
                        <div class="step-time" id="step1Time"></div>
                    </div>
                    <div class="workflow-step" id="step2" data-step="2">
                        <div class="step-icon">2</div>
                        <div class="step-label">ä¸Šä¼ æ–‡ä»¶</div>
                        <div class="step-time" id="step2Time"></div>
                    </div>
                    <div class="workflow-step" id="step3" data-step="3">
                        <div class="step-icon">3</div>
                        <div class="step-label">æ™ºèƒ½è¯†åˆ«</div>
                        <div class="step-time" id="step3Time"></div>
                    </div>
                    <div class="workflow-step" id="step4" data-step="4">
                        <div class="step-icon">4</div>
                        <div class="step-label">é¢„å½•å…¥</div>
                        <div class="step-time" id="step4Time"></div>
                    </div>
                    
                    <!-- å†å²ç¼“å­˜æŒ‰é’® -->
                    <button class="toolbar-btn toolbar-btn-history" id="toolbarHistoryBtn" title="å†å²ç¼“å­˜">
                        ğŸ“‚ å†å²ç¼“å­˜
                    </button>
                    
                    <div class="workflow-step" id="step5" data-step="5">
                        <div class="step-icon">5</div>
                        <div class="step-label">æ•°æ®æå–</div>
                        <div class="step-time" id="step5Time"></div>
                    </div>
                    <div class="workflow-step" id="step6" data-step="6">
                        <div class="step-icon">6</div>
                        <div class="step-label">è´¢åŠ¡ç¡®è®¤</div>
                        <div class="step-time" id="step6Time"></div>
                    </div>
                </div>
                
                <!-- æœåŠ¡çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                <div class="llm-status-bar" id="llmStatusBar">
                    <div class="llm-status-item" id="llmOcrStatus">
                        <span class="status-dot checking"></span>
                        <span class="status-label">OCRæ¨¡å‹</span>
                        <span class="status-text" id="llmOcrText">æ£€æµ‹ä¸­...</span>
                    </div>
                    <div class="llm-status-item" id="llmLlmStatus">
                        <span class="status-dot checking"></span>
                        <span class="status-label">LLMæœåŠ¡</span>
                        <span class="status-text" id="llmLlmText">æ£€æµ‹ä¸­...</span>
                    </div>
                    <div class="llm-status-item" id="llmRagStatus">
                        <span class="status-dot checking"></span>
                        <span class="status-label">RAGæœåŠ¡</span>
                        <span class="status-text" id="llmRagText">æ£€æµ‹ä¸­...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å†å²ç¼“å­˜å¼¹çª— -->
        <div class="history-modal-overlay" id="historyModalOverlay"></div>
        <div class="history-modal" id="historyModal">
            <div class="history-modal-header">
                <h3>ğŸ“‚ å†å²ç¼“å­˜</h3>
                <div class="history-modal-actions">
                    <button class="refresh-btn" onclick="window.loadHistoryPanel()" title="åˆ·æ–°">ğŸ”„</button>
                    <button class="close-btn" id="historyModalClose">âœ•</button>
                </div>
            </div>
            <div class="history-modal-body" id="historyPanelList">
                <div class="history-panel-empty">åŠ è½½ä¸­...</div>
            </div>
        </div>
        
        <!-- ä¸Šä¼ åŒºåŸŸ - ä»…åœ¨æ­¥éª¤2æ˜¾ç¤º -->
        <div class="upload-section" id="uploadSection">
            <!-- å•æ®ç±»å‹é€‰æ‹© -->
            <div class="document-type-selector" id="documentTypeSelector">
                <label for="documentTypeSelect">ğŸ“‹ å•æ®ç±»å‹ï¼š</label>
                <select id="documentTypeSelect">
                    <option value="">-- è¯·é€‰æ‹©å•æ®ç±»å‹ --</option>
                </select>
                <span class="doc-type-hint">ï¼ˆé€‰æ‹©åä¸Šä¼ æ–‡ä»¶ï¼Œå°†è‡ªåŠ¨åº”ç”¨å¯¹åº”çš„æå–æ¨¡æ¿ï¼‰</span>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <p>ğŸ“„ æ‹–æ‹½ PDFã€JPG æˆ– PNG æ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©</p>
                <p><small>æœ€å¤§æ–‡ä»¶: 50MB | æ”¯æŒ: PDF, JPG, PNG</small></p>
            </div>
            <input type="file" id="fileInput" class="file-input" accept=".pdf,.jpg,.jpeg,.png">
            
            <div id="status" class="status"></div>
            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-bar-fill" id="progressBarFill" style="width: 0%"></div>
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content" id="mainContent">
            <!-- å·¦ä¾§ï¼šåŸå§‹å›¾åƒ -->
            <div class="image-panel">
                <div class="image-panel-header">ğŸ“· åŸå§‹æ–‡æ¡£</div>
                <div class="image-container" id="imageContainer">
                    <div class="image-wrapper" id="imageWrapper">
                        <img id="documentImage" src="" alt="Document preview">
                    </div>
                </div>
                <div class="legend">
                    <span class="legend-item"><span class="legend-color normal"></span>è¯†åˆ«åŒºåŸŸ</span>
                    <span class="legend-item"><span class="legend-color hover"></span>æ‚¬åœ</span>
                    <span class="legend-item"><span class="legend-color active"></span>é€‰ä¸­</span>
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šç¼–è¾‘å™¨åŒº -->
            <div class="editor-panel">
                <div class="editor-panel-header">
                    <span>ğŸ“‹ è¯†åˆ«ç»“æœ</span>
                    <div class="edit-mode-toggle" id="editModeToggle">
                        <button id="blockModeBtn" class="mode-btn active" onclick="window.switchViewMode('block')" title="Block è§†å›¾">ğŸ“¦ Block</button>
                        <button id="markdownModeBtn" class="mode-btn" onclick="window.switchViewMode('markdown')" title="Markdown è§†å›¾">ğŸ“ Markdown</button>
                    </div>
                    <!-- æ™ºèƒ½æå–å’Œé—®ç­”æŒ‰é’® -->
                    <div class="smart-buttons" id="smartButtons">
                        <button class="smart-btn extract-btn" id="smartExtractBtn" onclick="window.openSmartExtract && window.openSmartExtract()" title="æ™ºèƒ½æå–å…³é”®ä¿¡æ¯">ğŸ”® æ™ºèƒ½æå–</button>
                        <button class="smart-btn qa-btn" id="smartQaBtn" onclick="window.openDocumentQA && window.openDocumentQA()" title="æ–‡æ¡£é—®ç­”">ğŸ’¬ é—®ç­”</button>
                    </div>
                    <!-- ç¡®è®¤è¿›å…¥æ­¥éª¤5æŒ‰é’® - æ”¾åœ¨æ™ºèƒ½æŒ‰é’®åé¢ -->
                    <button class="confirm-step5-btn" id="confirmStep5Btn" title="ç¡®è®¤é¢„å½•å…¥å®Œæˆï¼Œè¿›å…¥æ•°æ®æå–æ­¥éª¤" style="display: none;">
                        âœ… ç¡®è®¤è¿›å…¥æ­¥éª¤5
                    </button>
                    <div class="download-buttons" id="downloadButtons" style="display: none;">
                        <button class="download-btn" style="background: #e74c3c;" onclick="window.downloadOriginalFile()" title="ä¸‹è½½åŸå§‹ä¸Šä¼ æ–‡ä»¶">ğŸ“„ åŸå§‹æ–‡ä»¶</button>
                        <button class="download-btn" style="background: #17a2b8;" onclick="window.downloadConfidenceLog()" title="ç½®ä¿¡åº¦è®¡ç®—è¯¦ç»†æ—¥å¿—">ğŸ“Š ç½®ä¿¡åº¦LOG</button>
                        <button class="download-btn" style="background: #27ae60;" onclick="window.downloadPPStructure()" title="PPStructure å¸ƒå±€åˆ†æç»“æœ">ğŸ“ å¸ƒå±€JSON</button>
                        <button class="download-btn" style="background: #3498db;" onclick="window.downloadRawOcrJson()" title="æ–‡æœ¬OCRè¯†åˆ«ç»“æœJSON">ğŸ“ OCRç»“æœ</button>
                        <button class="download-btn" style="background: #9b59b6;" onclick="window.downloadRawHtml()" title="HTMLæ ¼å¼è¾“å‡º">ğŸŒ HTML</button>
                        <button class="download-btn" style="background: #6c5ce7;" onclick="window.downloadMarkdown()" title="Markdownæ ¼å¼è¾“å‡º">ğŸ“ MD</button>
                    </div>
                </div>
                <div id="confidenceReport"></div>
                <div class="editor-container">
                    <div id="blockList" class="block-list"></div>
                    <div id="markdownView" class="markdown-view" style="display: none;">
                        <div id="markdownContent" class="markdown-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç¼–è¾‘å¼¹çª—é®ç½© -->
    <div class="edit-overlay" id="editOverlay"></div>
    
    <!-- æ–‡æœ¬ç¼–è¾‘å¼¹çª— -->
    <div class="text-edit-popup" id="textEditPopup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000;">
        <div class="text-edit-header">
            <span>âœï¸ ç¼–è¾‘æ–‡æœ¬</span>
            <button class="close-btn" id="textEditClose">âœ•</button>
        </div>
        <textarea class="text-edit-input" id="textEditInput" placeholder="è¾“å…¥æ–‡æœ¬å†…å®¹..."></textarea>
        <div class="text-edit-footer">
            <button class="cancel-btn" id="textEditCancel">å–æ¶ˆ</button>
            <button class="save-btn" id="textEditSave">ä¿å­˜</button>
        </div>
    </div>
    
    <!-- è¡¨æ ¼ç¼–è¾‘å¼¹çª— -->
    <div class="table-edit-popup" id="tableEditPopup">
        <div class="table-edit-header">
            <h3>ğŸ“Š ç¼–è¾‘è¡¨æ ¼</h3>
            <button id="tableEditClose" style="background:none;border:none;font-size:18px;cursor:pointer;">âœ•</button>
        </div>
        <div class="table-edit-content" id="tableEditContent"></div>
        <div class="table-edit-footer">
            <button class="cancel-btn" id="tableEditCancel">å–æ¶ˆ</button>
            <button class="save-btn" id="tableEditSave">ä¿å­˜</button>
        </div>
    </div>
    
    <!-- å…¨å±€å‡½æ•° -->
    <script src="utils/globalFunctions.js?v=22"></script>
    
    <!-- ä¸»åº”ç”¨ -->
    <script type="module" src="index.js?v=33"></script>
    
    <!-- æ™ºèƒ½æ–‡æ¡£ç†è§£ç»„ä»¶ -->
    <script src="components/SmartExtract.js?v=2"></script>
    <script src="components/DocumentQA.js?v=2"></script>
    <script src="components/ChatOCRIntegration.js?v=2"></script>
    <script src="components/DocumentTypeConfig.js?v=2"></script>
    
    <!-- æ­¥éª¤ç»„ä»¶ -->
    <script type="module">
        import { Step4PreEntry } from './components/steps/Step4PreEntry.js?v=16';
        import { Step5DataExtract } from './components/steps/Step5DataExtract.js?v=35';
        import { Step6Confirmation } from './components/steps/Step6Confirmation.js?v=18';
        
        // æ³¨å†Œåˆ°å…¨å±€
        window.Step4PreEntry = Step4PreEntry;
        window.Step5DataExtract = Step5DataExtract;
        window.Step6Confirmation = Step6Confirmation;
        
        // åˆ›å»ºç»„ä»¶å®ä¾‹
        window.step4Component = new Step4PreEntry(document.body);
        window.step5Component = new Step5DataExtract(document.body);
        window.step6Component = new Step6Confirmation(document.body);
        
        console.log('Step components registered');
    </script>
    
    <!-- åˆå§‹åŒ– -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–å•æ®ç±»å‹é…ç½®
            if (typeof initDocumentTypeConfig === 'function') {
                window.docTypeConfig = initDocumentTypeConfig({ apiBaseUrl: '' });
                console.log('DocumentTypeConfig initialized');
            }
            
            // å·¥å…·æ  - å•æ®è®¾å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            var toolbarDocTypeBtn = document.getElementById('toolbarDocTypeBtn');
            if (toolbarDocTypeBtn) {
                toolbarDocTypeBtn.addEventListener('click', function() {
                    if (window.docTypeConfig) {
                        window.docTypeConfig.show();
                    }
                });
            }
            
            // å·¥å…·æ  - å†å²ç¼“å­˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            var toolbarHistoryBtn = document.getElementById('toolbarHistoryBtn');
            var historyModal = document.getElementById('historyModal');
            var historyModalOverlay = document.getElementById('historyModalOverlay');
            var historyModalClose = document.getElementById('historyModalClose');
            
            function showHistoryModal() {
                if (historyModal && historyModalOverlay) {
                    historyModalOverlay.classList.add('visible');
                    historyModal.classList.add('visible');
                    // åŠ è½½å†å²æ•°æ®
                    if (window.loadHistoryPanel) {
                        window.loadHistoryPanel();
                    }
                }
            }
            
            function hideHistoryModal() {
                if (historyModal && historyModalOverlay) {
                    historyModalOverlay.classList.remove('visible');
                    historyModal.classList.remove('visible');
                }
            }
            
            if (toolbarHistoryBtn) {
                toolbarHistoryBtn.addEventListener('click', showHistoryModal);
            }
            
            if (historyModalClose) {
                historyModalClose.addEventListener('click', hideHistoryModal);
            }
            
            if (historyModalOverlay) {
                historyModalOverlay.addEventListener('click', hideHistoryModal);
            }
            
            // æš´éœ²åˆ°å…¨å±€ä¾›å…¶ä»–åœ°æ–¹è°ƒç”¨
            window.showHistoryModal = showHistoryModal;
            window.hideHistoryModal = hideHistoryModal;
            
            // ç›‘å¬è¯†åˆ«å®Œæˆäº‹ä»¶ï¼Œæ˜¾ç¤ºç¡®è®¤æŒ‰é’®
            if (window.eventBus && window.EVENTS) {
                window.eventBus.on(window.EVENTS.RECOGNITION_COMPLETED, function(data) {
                    console.log('=== RECOGNITION_COMPLETED in init script ===');
                    var confirmBtn = document.getElementById('confirmStep5Btn');
                    if (confirmBtn) {
                        confirmBtn.style.display = 'inline-block';
                        console.log('Confirm button shown via init script');
                    }
                });
            }
            
            // ç»‘å®šç¡®è®¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            var confirmBtn = document.getElementById('confirmStep5Btn');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', function() {
                    console.log('Confirm button clicked');
                    
                    // æ›´æ–°æ­¥éª¤çŠ¶æ€
                    if (window.updateStepStatus) {
                        window.updateStepStatus(4, 'completed', 'âœ“');
                        window.updateStepStatus(5, 'active');
                    }
                    
                    // éšè—æŒ‰é’®
                    confirmBtn.style.display = 'none';
                    
                    // éšè—æ­¥éª¤4ç•Œé¢å…ƒç´ 
                    var blockList = document.getElementById('blockList');
                    var imagePanel = document.querySelector('.image-panel');
                    var downloadButtons = document.getElementById('downloadButtons');
                    var confidenceReport = document.getElementById('confidenceReport');
                    var editModeToggle = document.getElementById('editModeToggle');
                    
                    if (blockList) blockList.style.display = 'none';
                    if (imagePanel) imagePanel.style.display = 'none';
                    if (downloadButtons) downloadButtons.style.display = 'none';
                    if (confidenceReport) confidenceReport.style.display = 'none';
                    if (editModeToggle) editModeToggle.style.display = 'none';
                    
                    // éšè— OCR åŒºåŸŸæ ‡è®°
                    document.querySelectorAll('.ocr-region').forEach(function(el) { el.style.display = 'none'; });
                    
                    // æ˜¾ç¤ºæ­¥éª¤5ç•Œé¢
                    if (window.step5Component) {
                        window.step5Component.show();
                        console.log('Step 5 component shown');
                    } else {
                        console.error('Step5 component not found');
                        alert('æ­¥éª¤5ç»„ä»¶æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢');
                    }
                });
                console.log('Confirm button click handler bound');
            }
            
            setTimeout(function() {
                // åˆå§‹åŒ–æ™ºèƒ½åŠŸèƒ½
                if (typeof initChatOCRIntegration === 'function' && window.app) {
                    window.chatOCR = initChatOCRIntegration({ apiBaseUrl: '' });
                    console.log('ChatOCR integration initialized');
                    
                    // ç›‘å¬ jobId å˜åŒ–
                    var originalHandleComplete = window.app.handleProcessingComplete.bind(window.app);
                    window.app.handleProcessingComplete = async function(data, jobId) {
                        await originalHandleComplete(data, jobId);
                        if (window.chatOCR) {
                            window.chatOCR.setJobId(jobId);
                        }
                        // ç¡®ä¿ç¡®è®¤æŒ‰é’®æ˜¾ç¤º
                        var confirmBtn = document.getElementById('confirmStep5Btn');
                        if (confirmBtn) {
                            confirmBtn.style.display = 'inline-block';
                            console.log('Confirm button shown via wrapper');
                        }
                        // éšè—ä¸Šä¼ åŒºåŸŸï¼ˆè¿›å…¥æ­¥éª¤3åï¼‰
                        var uploadSection = document.getElementById('uploadSection');
                        if (uploadSection) {
                            uploadSection.style.display = 'none';
                        }
                    };
                    
                    if (window.app && window.app.currentJobId) {
                        window.chatOCR.setJobId(window.app.currentJobId);
                    }
                }
            }, 800);
        });
        
        // åˆ·æ–°å•æ®ç±»å‹ä¸‹æ‹‰æ¡†ï¼ˆä¾›å¤–éƒ¨è°ƒç”¨ï¼‰
        window.refreshDocumentTypeSelect = async function() {
            console.log('refreshDocumentTypeSelect called');
            var select = document.getElementById('documentTypeSelect');
            if (!select) return;
            
            try {
                var res = await fetch('/api/document-types');
                var data = await res.json();
                console.log('Document types API response:', data);
                
                // å…¼å®¹ä¸¤ç§è¿”å›æ ¼å¼ï¼šdata æˆ– document_types
                var docTypes = data.data || data.document_types || [];
                
                if (data.success && docTypes.length > 0) {
                    // ä¿ç•™å½“å‰é€‰ä¸­å€¼
                    var currentValue = select.value;
                    
                    // æ¸…ç©ºå¹¶é‡å»ºé€‰é¡¹
                    select.innerHTML = '<option value="">-- è¯·é€‰æ‹©å•æ®ç±»å‹ --</option>';
                    docTypes.forEach(function(dt) {
                        var option = document.createElement('option');
                        option.value = dt.id;
                        option.textContent = dt.name;
                        select.appendChild(option);
                    });
                    
                    // æ¢å¤é€‰ä¸­å€¼
                    if (currentValue) {
                        select.value = currentValue;
                    }
                    
                    console.log('Document types loaded:', docTypes.length);
                } else {
                    console.log('No document types found or API failed');
                }
            } catch (e) {
                console.error('Failed to load document types:', e);
            }
        };
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–å•æ®ç±»å‹ä¸‹æ‹‰æ¡†
        window.refreshDocumentTypeSelect();
        
        // ç›‘å¬å•æ®ç±»å‹é€‰æ‹©å˜åŒ–
        var docTypeSelect = document.getElementById('documentTypeSelect');
        if (docTypeSelect) {
            docTypeSelect.addEventListener('change', function() {
                var selectedId = this.value;
                console.log('Document type selected:', selectedId);
                if (window.stateManager) {
                    window.stateManager.set('selectedDocumentTypeId', selectedId);
                }
            });
        }
    </script>
</body>
</html>
