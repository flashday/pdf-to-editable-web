<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å¿ƒå•æ®å¤„ç†ç³»ç»Ÿ</title>
    
    <!-- å¤–éƒ¨ä¾èµ– -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- CSS æ¨¡å— -->
    <link rel="stylesheet" href="styles/base.css?v=15">
    <link rel="stylesheet" href="styles/layout.css?v=19">
    <link rel="stylesheet" href="styles/steps.css?v=23">
    <link rel="stylesheet" href="styles/panels.css?v=15">
    <link rel="stylesheet" href="styles/components.css?v=18">
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ä¸­å¿ƒå•æ®å¤„ç†ç³»ç»Ÿ</h1>
        </div>
        
        <!-- æµç¨‹è¿›åº¦æ¡ -->
        <div class="workflow-container">
            <!-- å·¦ä¾§ï¼šæœåŠ¡çŠ¶æ€æŒ‡ç¤ºå™¨ -->
            <div class="llm-status-bar" id="llmStatusBar">
                <div class="llm-status-item" id="llmOcrStatus">
                    <span class="status-dot checking"></span>
                    <span class="status-label">OCRæ¨¡å‹</span>
                    <span class="status-text" id="llmOcrText">æ£€æµ‹ä¸­...</span>
                </div>
                <div class="llm-status-item" id="llmLlmStatus">
                    <span class="status-dot checking"></span>
                    <span class="status-label">LLMæœåŠ¡</span>
                    <span class="status-text" id="llmLlmText">æ£€æµ‹ä¸­...</span>
                </div>
                <div class="llm-status-item" id="llmRagStatus">
                    <span class="status-dot checking"></span>
                    <span class="status-label">RAGæœåŠ¡</span>
                    <span class="status-text" id="llmRagText">æ£€æµ‹ä¸­...</span>
                </div>
            </div>
            
            <!-- ä¸­é—´ï¼šå·¥ä½œæµæ­¥éª¤ -->
            <div class="workflow-progress">
                <div class="workflow-steps" id="workflowSteps">
                    <div class="workflow-step" id="step1" data-step="1">
                        <div class="step-icon">1</div>
                        <div class="step-label">æ¨¡å‹åŠ è½½</div>
                        <div class="step-time" id="step1Time"></div>
                    </div>
                    <div class="workflow-step" id="step2" data-step="2">
                        <div class="step-icon">2</div>
                        <div class="step-label">ä¸Šä¼ æ–‡ä»¶</div>
                        <div class="step-time" id="step2Time"></div>
                    </div>
                    <div class="workflow-step" id="step3" data-step="3">
                        <div class="step-icon">3</div>
                        <div class="step-label">æ™ºèƒ½è¯†åˆ«</div>
                        <div class="step-time" id="step3Time"></div>
                    </div>
                    <div class="workflow-step" id="step4" data-step="4">
                        <div class="step-icon">4</div>
                        <div class="step-label">é¢„å½•å…¥</div>
                        <div class="step-time" id="step4Time"></div>
                    </div>
                    <div class="workflow-step" id="step5" data-step="5">
                        <div class="step-icon">5</div>
                        <div class="step-label">æ•°æ®æå–</div>
                        <div class="step-time" id="step5Time"></div>
                    </div>
                    <div class="workflow-step" id="step6" data-step="6">
                        <div class="step-icon">6</div>
                        <div class="step-label">è´¢åŠ¡ç¡®è®¤</div>
                        <div class="step-time" id="step6Time"></div>
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šå·¥å…·æŒ‰é’® -->
            <div class="toolbar-buttons">
                <button class="toolbar-btn toolbar-btn-config" id="toolbarDocTypeBtn" title="å•æ®è®¾å®š">
                    âš™ï¸ å•æ®è®¾å®š
                </button>
                <button class="toolbar-btn toolbar-btn-history" id="toolbarHistoryBtn" title="å†å²ç¼“å­˜">
                    ğŸ“‚ å†å²ç¼“å­˜
                </button>
            </div>
        </div>
        
        <!-- å†å²ç¼“å­˜å¼¹çª— -->
        <div class="history-modal-overlay" id="historyModalOverlay"></div>
        <div class="history-modal" id="historyModal">
            <div class="history-modal-header">
                <h3>ğŸ“‚ å†å²ç¼“å­˜</h3>
                <div class="history-modal-actions">
                    <button class="refresh-btn" onclick="window.loadHistoryPanel()" title="åˆ·æ–°">ğŸ”„</button>
                    <button class="close-btn" id="historyModalClose">âœ•</button>
                </div>
            </div>
            <div class="history-modal-body" id="historyPanelList">
                <div class="history-panel-empty">åŠ è½½ä¸­...</div>
            </div>
        </div>
        
        <!-- ä¸Šä¼ åŒºåŸŸ - ä»…åœ¨æ­¥éª¤2æ˜¾ç¤º -->
        <div class="upload-section" id="uploadSection">
            <!-- å•æ®ç±»å‹é€‰æ‹© -->
            <div class="document-type-selector" id="documentTypeSelector">
                <label for="documentTypeSelect">ğŸ“‹ å•æ®ç±»å‹ï¼š</label>
                <select id="documentTypeSelect">
                    <option value="">-- è¯·é€‰æ‹©å•æ®ç±»å‹ --</option>
                </select>
                <span class="doc-type-hint">ï¼ˆé€‰æ‹©åä¸Šä¼ æ–‡ä»¶ï¼Œå°†è‡ªåŠ¨åº”ç”¨å¯¹åº”çš„æå–æ¨¡æ¿ï¼‰</span>
            </div>
            
            <div class="upload-area" id="uploadArea" onclick="window.handleUploadAreaClick()">
                <p>ğŸ“„ æ‹–æ‹½ PDFã€JPG æˆ– PNG æ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©</p>
                <p><small>æœ€å¤§æ–‡ä»¶: 50MB | æ”¯æŒ: PDF, JPG, PNG</small></p>
            </div>
            <input type="file" id="fileInput" class="file-input" accept=".pdf,.jpg,.jpeg,.png">
            
            <div id="status" class="status"></div>
            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-bar-fill" id="progressBarFill" style="width: 0%"></div>
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content" id="mainContent">
            <!-- å·¦ä¾§ï¼šåŸå§‹å›¾åƒ -->
            <div class="image-panel">
                <div class="image-panel-header">ğŸ“· åŸå§‹æ–‡æ¡£</div>
                <div class="image-container" id="imageContainer">
                    <div class="image-wrapper" id="imageWrapper">
                        <img id="documentImage" src="" alt="Document preview">
                    </div>
                </div>
                <div class="legend">
                    <span class="legend-item"><span class="legend-color normal"></span>è¯†åˆ«åŒºåŸŸ</span>
                    <span class="legend-item"><span class="legend-color hover"></span>æ‚¬åœ</span>
                    <span class="legend-item"><span class="legend-color active"></span>é€‰ä¸­</span>
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šç¼–è¾‘å™¨åŒº -->
            <div class="editor-panel">
                <div class="editor-panel-header">
                    <span>ğŸ“‹ è¯†åˆ«ç»“æœ</span>
                    <div class="edit-mode-toggle" id="editModeToggle">
                        <button id="blockModeBtn" class="mode-btn active" onclick="window.switchViewMode('block')" title="Block è§†å›¾">ğŸ“¦ Block</button>
                        <button id="markdownModeBtn" class="mode-btn" onclick="window.switchViewMode('markdown')" title="Markdown è§†å›¾">ğŸ“ Markdown</button>
                    </div>
                    <!-- æ™ºèƒ½æå–å’Œé—®ç­”æŒ‰é’® - æš‚æ—¶éšè— -->
                    <div class="smart-buttons" id="smartButtons" style="display: none;">
                        <button class="smart-btn extract-btn" id="smartExtractBtn" onclick="window.openSmartExtract && window.openSmartExtract()" title="æ™ºèƒ½æå–å…³é”®ä¿¡æ¯">ğŸ”® æ™ºèƒ½æå–</button>
                        <button class="smart-btn qa-btn" id="smartQaBtn" onclick="window.openDocumentQA && window.openDocumentQA()" title="æ–‡æ¡£é—®ç­”">ğŸ’¬ é—®ç­”</button>
                    </div>
                    <!-- ç¡®è®¤è¿›å…¥æ•°æ®æå–æŒ‰é’® - æ”¾åœ¨æ™ºèƒ½æŒ‰é’®åé¢ -->
                    <button class="confirm-step5-btn" id="confirmStep5Btn" title="ç¡®è®¤é¢„å½•å…¥å®Œæˆï¼Œè¿›å…¥æ•°æ®æå–æ­¥éª¤" style="display: none;">
                        âœ… ç¡®è®¤è¿›å…¥æ•°æ®æå–
                    </button>
                    <div class="download-buttons" id="downloadButtons" style="display: none;">
                        <button class="download-btn" style="background: #e74c3c;" onclick="window.downloadOriginalFile()" title="ä¸‹è½½åŸå§‹ä¸Šä¼ æ–‡ä»¶">ğŸ“„ åŸå§‹æ–‡ä»¶</button>
                        <button class="download-btn" style="background: #17a2b8;" onclick="window.downloadConfidenceLog()" title="ç½®ä¿¡åº¦è®¡ç®—è¯¦ç»†æ—¥å¿—">ğŸ“Š ç½®ä¿¡åº¦LOG</button>
                        <button class="download-btn" style="background: #27ae60;" onclick="window.downloadPPStructure()" title="PPStructure å¸ƒå±€åˆ†æç»“æœ">ğŸ“ å¸ƒå±€JSON</button>
                        <button class="download-btn" style="background: #3498db;" onclick="window.downloadRawOcrJson()" title="æ–‡æœ¬OCRè¯†åˆ«ç»“æœJSON">ğŸ“ OCRç»“æœ</button>
                        <button class="download-btn" style="background: #9b59b6;" onclick="window.downloadRawHtml()" title="HTMLæ ¼å¼è¾“å‡º">ğŸŒ HTML</button>
                        <button class="download-btn" style="background: #6c5ce7;" onclick="window.downloadMarkdown()" title="Markdownæ ¼å¼è¾“å‡º">ğŸ“ MD</button>
                    </div>
                </div>
                <div id="confidenceReport"></div>
                <div class="editor-container">
                    <div id="blockList" class="block-list"></div>
                    <div id="markdownView" class="markdown-view" style="display: none;">
                        <div id="markdownContent" class="markdown-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç¼–è¾‘å¼¹çª—é®ç½© -->
    <div class="edit-overlay" id="editOverlay"></div>
    
    <!-- æ–‡æœ¬ç¼–è¾‘å¼¹çª— -->
    <div class="text-edit-popup" id="textEditPopup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000;">
        <div class="text-edit-header">
            <span>âœï¸ ç¼–è¾‘æ–‡æœ¬</span>
            <button class="close-btn" id="textEditClose">âœ•</button>
        </div>
        <textarea class="text-edit-input" id="textEditInput" placeholder="è¾“å…¥æ–‡æœ¬å†…å®¹..."></textarea>
        <div class="text-edit-footer">
            <button class="cancel-btn" id="textEditCancel">å–æ¶ˆ</button>
            <button class="save-btn" id="textEditSave">ä¿å­˜</button>
        </div>
    </div>
    
    <!-- è¡¨æ ¼ç¼–è¾‘å¼¹çª— -->
    <div class="table-edit-popup" id="tableEditPopup">
        <div class="table-edit-header">
            <h3>ğŸ“Š ç¼–è¾‘è¡¨æ ¼</h3>
            <button id="tableEditClose" style="background:none;border:none;font-size:18px;cursor:pointer;">âœ•</button>
        </div>
        <div class="table-edit-content" id="tableEditContent"></div>
        <div class="table-edit-footer">
            <button class="cancel-btn" id="tableEditCancel">å–æ¶ˆ</button>
            <button class="save-btn" id="tableEditSave">ä¿å­˜</button>
        </div>
    </div>
    
    <!-- å…¨å±€å‡½æ•° -->
    <script src="utils/globalFunctions.js?v=28"></script>
    
    <!-- ä¸»åº”ç”¨ - æ·»åŠ æ—¶é—´æˆ³å¼ºåˆ¶åˆ·æ–° -->
    <script type="module" src="index.js?v=52&t=20260128a"></script>
    
    <!-- æ™ºèƒ½æ–‡æ¡£ç†è§£ç»„ä»¶ -->
    <script src="components/SmartExtract.js?v=2"></script>
    <script src="components/DocumentQA.js?v=2"></script>
    <script src="components/ChatOCRIntegration.js?v=2"></script>
    <script src="components/DocumentTypeConfig.js?v=2"></script>
    
    <!-- æ­¥éª¤ç»„ä»¶ -->
    <script type="module">
        import { Step4PreEntry } from './components/steps/Step4PreEntry.js?v=17';
        import { Step5DataExtract } from './components/steps/Step5DataExtract.js?v=37';
        import { Step6Confirmation } from './components/steps/Step6Confirmation.js?v=19';
        
        // æ³¨å†Œåˆ°å…¨å±€
        window.Step4PreEntry = Step4PreEntry;
        window.Step5DataExtract = Step5DataExtract;
        window.Step6Confirmation = Step6Confirmation;
        
        // åˆ›å»ºç»„ä»¶å®ä¾‹
        window.step4Component = new Step4PreEntry(document.body);
        window.step5Component = new Step5DataExtract(document.body);
        window.step6Component = new Step6Confirmation(document.body);
        
        console.log('Step components registered');
    </script>
    
    <!-- åˆå§‹åŒ– -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–å•æ®ç±»å‹é…ç½®
            if (typeof initDocumentTypeConfig === 'function') {
                window.docTypeConfig = initDocumentTypeConfig({ apiBaseUrl: '' });
                console.log('DocumentTypeConfig initialized');
            }
            
            // å·¥å…·æ  - å•æ®è®¾å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            var toolbarDocTypeBtn = document.getElementById('toolbarDocTypeBtn');
            if (toolbarDocTypeBtn) {
                toolbarDocTypeBtn.addEventListener('click', function() {
                    if (window.docTypeConfig) {
                        window.docTypeConfig.show();
                    }
                });
            }
            
            // å·¥å…·æ  - å†å²ç¼“å­˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            var toolbarHistoryBtn = document.getElementById('toolbarHistoryBtn');
            var historyModal = document.getElementById('historyModal');
            var historyModalOverlay = document.getElementById('historyModalOverlay');
            var historyModalClose = document.getElementById('historyModalClose');
            
            function showHistoryModal() {
                if (historyModal && historyModalOverlay) {
                    historyModalOverlay.classList.add('visible');
                    historyModal.classList.add('visible');
                    // åŠ è½½å†å²æ•°æ®
                    if (window.loadHistoryPanel) {
                        window.loadHistoryPanel();
                    }
                }
            }
            
            function hideHistoryModal() {
                if (historyModal && historyModalOverlay) {
                    historyModalOverlay.classList.remove('visible');
                    historyModal.classList.remove('visible');
                }
            }
            
            if (toolbarHistoryBtn) {
                toolbarHistoryBtn.addEventListener('click', showHistoryModal);
            }
            
            if (historyModalClose) {
                historyModalClose.addEventListener('click', hideHistoryModal);
            }
            
            if (historyModalOverlay) {
                historyModalOverlay.addEventListener('click', hideHistoryModal);
            }
            
            // æš´éœ²åˆ°å…¨å±€ä¾›å…¶ä»–åœ°æ–¹è°ƒç”¨
            window.showHistoryModal = showHistoryModal;
            window.hideHistoryModal = hideHistoryModal;
            
            // ç›‘å¬è¯†åˆ«å®Œæˆäº‹ä»¶ï¼Œæ˜¾ç¤ºç¡®è®¤æŒ‰é’®
            if (window.eventBus && window.EVENTS) {
                window.eventBus.on(window.EVENTS.RECOGNITION_COMPLETED, function(data) {
                    console.log('=== RECOGNITION_COMPLETED in init script ===');
                    var confirmBtn = document.getElementById('confirmStep5Btn');
                    if (confirmBtn) {
                        confirmBtn.style.display = 'inline-block';
                        console.log('Confirm button shown via init script');
                    }
                });
            }
            
            // ç»‘å®šç¡®è®¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            var confirmBtn = document.getElementById('confirmStep5Btn');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', function() {
                    console.log('Confirm button clicked');
                    
                    // æ›´æ–°æ­¥éª¤çŠ¶æ€
                    if (window.updateStepStatus) {
                        window.updateStepStatus(4, 'completed', 'âœ“');
                        window.updateStepStatus(5, 'active');
                    }
                    
                    // éšè—æŒ‰é’®
                    confirmBtn.style.display = 'none';
                    
                    // éšè—æ­¥éª¤4ç•Œé¢å…ƒç´ 
                    var blockList = document.getElementById('blockList');
                    var imagePanel = document.querySelector('.image-panel');
                    var downloadButtons = document.getElementById('downloadButtons');
                    var confidenceReport = document.getElementById('confidenceReport');
                    var editModeToggle = document.getElementById('editModeToggle');
                    
                    if (blockList) blockList.style.display = 'none';
                    if (imagePanel) imagePanel.style.display = 'none';
                    if (downloadButtons) downloadButtons.style.display = 'none';
                    if (confidenceReport) confidenceReport.style.display = 'none';
                    if (editModeToggle) editModeToggle.style.display = 'none';
                    
                    // éšè— OCR åŒºåŸŸæ ‡è®°
                    document.querySelectorAll('.ocr-region').forEach(function(el) { el.style.display = 'none'; });
                    
                    // æ˜¾ç¤ºæ­¥éª¤5ç•Œé¢
                    if (window.step5Component) {
                        window.step5Component.show();
                        console.log('Step 5 component shown');
                    } else {
                        console.error('Step5 component not found');
                        alert('æ­¥éª¤5ç»„ä»¶æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢');
                    }
                });
                console.log('Confirm button click handler bound');
            }
            
            setTimeout(function() {
                // åˆå§‹åŒ–æ™ºèƒ½åŠŸèƒ½
                if (typeof initChatOCRIntegration === 'function' && window.app) {
                    window.chatOCR = initChatOCRIntegration({ apiBaseUrl: '' });
                    console.log('ChatOCR integration initialized');
                    
                    // ç›‘å¬ jobId å˜åŒ– - åŒ…è£… handleProcessingComplete
                    // æ³¨æ„ï¼šä¸å†åŒ…è£… handleProcessingCompleteï¼Œå› ä¸ºä¼šå¯¼è‡´æ–¹æ³•ä¸è¢«æ­£ç¡®è°ƒç”¨
                    // æ”¹ä¸ºåœ¨ handleProcessingComplete å®Œæˆåé€šè¿‡äº‹ä»¶é€šçŸ¥
                    console.log('ChatOCR: Skipping handleProcessingComplete wrapper (causes issues)');
                    
                    if (window.app && window.app.currentJobId) {
                        window.chatOCR.setJobId(window.app.currentJobId);
                    }
                }
            }, 800);
        });
        
        // åˆ·æ–°å•æ®ç±»å‹ä¸‹æ‹‰æ¡†ï¼ˆä¾›å¤–éƒ¨è°ƒç”¨ï¼‰
        window.refreshDocumentTypeSelect = async function() {
            console.log('refreshDocumentTypeSelect called');
            var select = document.getElementById('documentTypeSelect');
            if (!select) return;
            
            try {
                var res = await fetch('/api/document-types');
                var data = await res.json();
                console.log('Document types API response:', data);
                
                // å…¼å®¹ä¸¤ç§è¿”å›æ ¼å¼ï¼šdata æˆ– document_types
                var docTypes = data.data || data.document_types || [];
                
                if (data.success && docTypes.length > 0) {
                    // ä¿ç•™å½“å‰é€‰ä¸­å€¼
                    var currentValue = select.value;
                    
                    // æ¸…ç©ºå¹¶é‡å»ºé€‰é¡¹
                    select.innerHTML = '<option value="">-- è¯·é€‰æ‹©å•æ®ç±»å‹ --</option>';
                    docTypes.forEach(function(dt) {
                        var option = document.createElement('option');
                        option.value = dt.id;
                        option.textContent = dt.name;
                        select.appendChild(option);
                    });
                    
                    // æ¢å¤é€‰ä¸­å€¼
                    if (currentValue) {
                        select.value = currentValue;
                    }
                    
                    console.log('Document types loaded:', docTypes.length);
                } else {
                    console.log('No document types found or API failed');
                }
            } catch (e) {
                console.error('Failed to load document types:', e);
            }
        };
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–å•æ®ç±»å‹ä¸‹æ‹‰æ¡†
        window.refreshDocumentTypeSelect();
        
        // ç›‘å¬å•æ®ç±»å‹é€‰æ‹©å˜åŒ–
        var docTypeSelect = document.getElementById('documentTypeSelect');
        if (docTypeSelect) {
            docTypeSelect.addEventListener('change', function() {
                var selectedId = this.value;
                console.log('Document type selected:', selectedId);
                if (window.stateManager) {
                    window.stateManager.set('selectedDocumentTypeId', selectedId);
                }
            });
        }
    </script>
    
    <!-- æ–¹æ¡ˆAï¼šå†…è”ä¸Šä¼ è„šæœ¬ - è°ƒç”¨ globalFunctions.js ç»Ÿä¸€å…¥å£ -->
    <script>
    (function() {
        console.log('=== INLINE UPLOAD SCRIPT v7 LOADED (æ–¹æ¡ˆA: ç»Ÿä¸€å…¥å£) ===');
        
        // ============================================================
        // å†…è”è¾…åŠ©å‡½æ•° - è°ƒç”¨ globalFunctions.js ä¸­çš„ç»Ÿä¸€å‡½æ•°
        // ============================================================
        
        // æ˜¾ç¤ºæ­¥éª¤4ç•Œé¢ - è°ƒç”¨å…¨å±€å‡½æ•°
        function showStep4UIInline() {
            if (window.showStep4UI) {
                window.showStep4UI();
            } else {
                console.error('showStep4UI not found in globalFunctions.js');
            }
        }
        
        // æå– OCR åŒºåŸŸ - è°ƒç”¨å…¨å±€å‡½æ•°
        function extractOCRRegionsInline(blocks) {
            if (window.extractOCRRegions) {
                return window.extractOCRRegions(blocks);
            }
            console.error('extractOCRRegions not found in globalFunctions.js');
            return [];
        }
        
        // æ¸²æŸ“ Block åˆ—è¡¨ - è°ƒç”¨å…¨å±€å‡½æ•°
        function renderBlockListInline(blocks) {
            if (window.renderBlockList) {
                window.renderBlockList(blocks);
            } else {
                console.error('renderBlockList not found in globalFunctions.js');
            }
        }
        
        // æ˜¾ç¤ºç½®ä¿¡åº¦æŠ¥å‘Š - è°ƒç”¨å…¨å±€å‡½æ•°
        function showConfidenceReportInline(cr) {
            if (window.showConfidenceReport) {
                window.showConfidenceReport(cr);
            } else {
                console.error('showConfidenceReport not found in globalFunctions.js');
            }
        }
        
        // ç»˜åˆ¶ OCR åŒºåŸŸæ¡† - è°ƒç”¨å…¨å±€å‡½æ•°
        function drawOCRRegionsInline(blocks) {
            if (window.drawOCRRegions) {
                window.drawOCRRegions(blocks);
            } else {
                console.error('drawOCRRegions not found in globalFunctions.js');
            }
        }
        
        // ============================================================
        // åŸæœ‰ä¸Šä¼ å¤„ç†é€»è¾‘
        // ============================================================
        
        // ä¸Šä¼ åŒºåŸŸç‚¹å‡»å¤„ç† - æ£€æŸ¥å•æ®ç±»å‹
        window.handleUploadAreaClick = function() {
            var docTypeSelect = document.getElementById('documentTypeSelect');
            if (!docTypeSelect || !docTypeSelect.value || docTypeSelect.value.trim() === '') {
                alert('âš ï¸ è¯·å…ˆé€‰æ‹©å•æ®ç±»å‹ï¼Œå†ä¸Šä¼ æ–‡ä»¶ï¼');
                // èšç„¦åˆ°å•æ®ç±»å‹ä¸‹æ‹‰æ¡†
                if (docTypeSelect) {
                    docTypeSelect.focus();
                    docTypeSelect.style.outline = '2px solid #dc3545';
                    docTypeSelect.style.outlineOffset = '2px';
                    setTimeout(function() {
                        docTypeSelect.style.outline = '';
                        docTypeSelect.style.outlineOffset = '';
                    }, 2000);
                }
                return;
            }
            // å•æ®ç±»å‹å·²é€‰æ‹©ï¼Œè§¦å‘æ–‡ä»¶é€‰æ‹©
            document.getElementById('fileInput').click();
        };
        
        // ç­‰å¾… DOM å®Œå…¨å°±ç»ª
        function initUploadHandler() {
            var uploadArea = document.getElementById('uploadArea');
            var fileInput = document.getElementById('fileInput');
            
            console.log('initUploadHandler: uploadArea=', !!uploadArea, 'fileInput=', !!fileInput);
            
            if (!uploadArea || !fileInput) {
                console.error('Upload elements not found!');
                return;
            }
            
            // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ï¼ˆé€šè¿‡å…‹éš†èŠ‚ç‚¹ï¼‰
            var newFileInput = fileInput.cloneNode(true);
            fileInput.parentNode.replaceChild(newFileInput, fileInput);
            fileInput = newFileInput;
            
            // ç»‘å®šæ–‡ä»¶é€‰æ‹©äº‹ä»¶
            fileInput.addEventListener('change', function(e) {
                console.log('=== INLINE: fileInput change event ===');
                var file = e.target.files[0];
                if (file) {
                    console.log('File selected:', file.name, file.type, file.size);
                    handleFileUploadInline(file);
                }
            });
            
            // ç»‘å®šæ‹–æ‹½äº‹ä»¶
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.remove('dragover');
                console.log('=== INLINE: drop event ===');
                var file = e.dataTransfer.files[0];
                if (file) {
                    console.log('File dropped:', file.name, file.type, file.size);
                    handleFileUploadInline(file);
                }
            });
            
            console.log('Inline upload handlers bound successfully');
        }
        
        // å†…è”ä¸Šä¼ å¤„ç†å‡½æ•°
        async function handleFileUploadInline(file) {
            console.log('=== handleFileUploadInline START ===');
            
            // æ£€æŸ¥æ˜¯å¦å·²é€‰æ‹©å•æ®ç±»å‹
            var docTypeSelect = document.getElementById('documentTypeSelect');
            if (!docTypeSelect || !docTypeSelect.value || docTypeSelect.value.trim() === '') {
                alert('âš ï¸ è¯·å…ˆé€‰æ‹©å•æ®ç±»å‹ï¼Œå†ä¸Šä¼ æ–‡ä»¶ï¼');
                // èšç„¦åˆ°å•æ®ç±»å‹ä¸‹æ‹‰æ¡†
                if (docTypeSelect) {
                    docTypeSelect.focus();
                    docTypeSelect.style.outline = '2px solid #dc3545';
                    docTypeSelect.style.outlineOffset = '2px';
                    setTimeout(function() {
                        docTypeSelect.style.outline = '';
                        docTypeSelect.style.outlineOffset = '';
                    }, 2000);
                }
                return;
            }
            
            // éªŒè¯æ–‡ä»¶ç±»å‹
            var allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
            var allowedExtensions = ['.pdf', '.jpg', '.jpeg', '.png'];
            var fileName = file.name.toLowerCase();
            var isValidType = allowedTypes.includes(file.type) || 
                              allowedExtensions.some(function(ext) { return fileName.endsWith(ext); });
            
            if (!isValidType) {
                alert('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼è¯·ä¸Šä¼  PDFã€JPG æˆ– PNG æ–‡ä»¶ã€‚');
                return;
            }
            
            // éªŒè¯æ–‡ä»¶å¤§å° (50MB)
            if (file.size > 50 * 1024 * 1024) {
                alert('æ–‡ä»¶å¤ªå¤§ï¼æœ€å¤§æ”¯æŒ 50MBã€‚');
                return;
            }
            
            // æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€
            var statusDiv = document.getElementById('status');
            var progressBar = document.getElementById('progressBar');
            var progressBarFill = document.getElementById('progressBarFill');
            
            if (statusDiv) {
                statusDiv.textContent = 'æ­£åœ¨ä¸Šä¼ : ' + file.name;
                statusDiv.className = 'status processing';
                statusDiv.style.display = 'block';
            }
            if (progressBar) {
                progressBar.style.display = 'block';
                progressBarFill.style.width = '10%';
            }
            
            try {
                // å‡†å¤‡ä¸Šä¼ æ•°æ®
                var formData = new FormData();
                formData.append('file', file);
                
                // è·å–é€‰ä¸­çš„å•æ®ç±»å‹
                var docTypeSelect = document.getElementById('documentTypeSelect');
                if (docTypeSelect && docTypeSelect.value) {
                    formData.append('document_type_id', docTypeSelect.value);
                    console.log('Document type ID:', docTypeSelect.value);
                }
                
                console.log('Uploading to /api/convert...');
                
                // ä¸Šä¼ æ–‡ä»¶
                var response = await fetch('/api/convert', {
                    method: 'POST',
                    body: formData
                });
                
                var data = await response.json();
                console.log('Upload response:', data);
                
                if (progressBarFill) progressBarFill.style.width = '30%';
                
                // åç«¯è¿”å› job_idï¼ˆä¸‹åˆ’çº¿ï¼‰ï¼ŒçŠ¶æ€ç  202 è¡¨ç¤ºæˆåŠŸ
                if (response.ok && data.job_id) {
                    var jobId = data.job_id;
                    console.log('Upload successful, jobId:', jobId);
                    
                    // ä¿å­˜ jobId åˆ°å…¨å±€
                    window.currentJobId = jobId;
                    if (window.app) window.app.currentJobId = jobId;
                    
                    // æ›´æ–°æ­¥éª¤çŠ¶æ€ï¼šæ­¥éª¤2å®Œæˆï¼Œæ­¥éª¤3æ¿€æ´»
                    console.log('Updating step status: step2=completed, step3=active');
                    if (window.updateStepStatus) {
                        window.updateStepStatus(2, 'completed', 'âœ“');
                        window.updateStepStatus(3, 'active');
                    }
                    
                    // éšè—ä¸Šä¼ åŒºåŸŸï¼Œä½†ä¿ç•™çŠ¶æ€æ˜¾ç¤º
                    var uploadSection = document.getElementById('uploadSection');
                    var uploadArea = document.getElementById('uploadArea');
                    var documentTypeSelector = document.getElementById('documentTypeSelector');
                    
                    // åªéšè—ä¸Šä¼ åŒºåŸŸå’Œå•æ®ç±»å‹é€‰æ‹©å™¨ï¼Œä¿ç•™çŠ¶æ€å’Œè¿›åº¦æ¡
                    if (uploadArea) uploadArea.style.display = 'none';
                    if (documentTypeSelector) documentTypeSelector.style.display = 'none';
                    
                    // æ˜¾ç¤ºå¤„ç†ä¸­çŠ¶æ€
                    if (statusDiv) {
                        statusDiv.textContent = 'OCR è¯†åˆ«å¤„ç†ä¸­...';
                        statusDiv.className = 'status processing';
                        statusDiv.style.display = 'block';
                    }
                    if (progressBar) {
                        progressBar.style.display = 'block';
                    }
                    
                    // å‘å¸ƒäº‹ä»¶ï¼ˆå¦‚æœ EventBus å¯ç”¨ï¼‰
                    if (window.eventBus && window.EVENTS) {
                        window.eventBus.emit(window.EVENTS.UPLOAD_COMPLETED, { jobId: jobId, file: file });
                    }
                    
                    // å¼€å§‹è½®è¯¢ OCR çŠ¶æ€
                    pollOcrStatusInline(jobId);
                    
                } else {
                    throw new Error(data.error || 'ä¸Šä¼ å¤±è´¥');
                }
                
            } catch (error) {
                console.error('Upload error:', error);
                if (statusDiv) {
                    statusDiv.textContent = 'ä¸Šä¼ å¤±è´¥: ' + error.message;
                    statusDiv.className = 'status error';
                }
                if (progressBar) progressBar.style.display = 'none';
            }
        }
        
        // å†…è”è½®è¯¢ OCR çŠ¶æ€
        async function pollOcrStatusInline(jobId) {
            console.log('=== pollOcrStatusInline START ===', jobId);
            
            var statusDiv = document.getElementById('status');
            var progressBarFill = document.getElementById('progressBarFill');
            var maxAttempts = 120; // æœ€å¤šè½®è¯¢ 120 æ¬¡ï¼ˆçº¦ 2 åˆ†é’Ÿï¼‰
            var attempt = 0;
            var pollInterval = 1000; // 1 ç§’
            
            async function poll() {
                attempt++;
                console.log('Polling attempt', attempt, 'for job', jobId);
                
                try {
                    var response = await fetch('/api/convert/' + jobId + '/status');
                    var data = await response.json();
                    console.log('Status response:', data);
                    
                    // æ›´æ–°è¿›åº¦æ¡
                    // æ³¨æ„ï¼šåç«¯è¿”å›çš„ progress å·²ç»æ˜¯ç™¾åˆ†æ¯”ï¼ˆ0-100ï¼‰
                    var progress = data.progress || 0;
                    if (progressBarFill) {
                        // è¿›åº¦æ¡ï¼š30% æ˜¯ä¸Šä¼ å®Œæˆï¼Œå‰©ä½™ 70% ç”¨äº OCR å¤„ç†
                        progressBarFill.style.width = (30 + progress * 0.7) + '%';
                    }
                    
                    if (data.status === 'completed') {
                        console.log('OCR completed!');
                        if (progressBarFill) progressBarFill.style.width = '100%';
                        if (statusDiv) {
                            statusDiv.textContent = 'OCR è¯†åˆ«å®Œæˆï¼';
                            statusDiv.className = 'status success';
                        }
                        
                        // æ›´æ–°æ­¥éª¤çŠ¶æ€ï¼šæ­¥éª¤3å®Œæˆï¼Œæ­¥éª¤4æ¿€æ´»
                        if (window.updateStepStatus) {
                            window.updateStepStatus(3, 'completed', 'âœ“');
                            window.updateStepStatus(4, 'active');
                        }
                        
                        // éšè—æ•´ä¸ªä¸Šä¼ åŒºåŸŸï¼ˆè¯†åˆ«å®Œæˆåï¼‰
                        var uploadSection = document.getElementById('uploadSection');
                        if (uploadSection) uploadSection.style.display = 'none';
                        
                        // è·å–å®Œæ•´ç»“æœ
                        var resultResponse = await fetch('/api/convert/' + jobId + '/result');
                        var resultData = await resultResponse.json();
                        console.log('Result data:', resultData);
                        console.log('Result data keys:', Object.keys(resultData));
                        console.log('Result data.result:', resultData.result);
                        console.log('Result data.result.blocks:', resultData.result ? resultData.result.blocks : 'N/A');
                        
                        // å‘å¸ƒè¯†åˆ«å®Œæˆäº‹ä»¶
                        if (window.eventBus && window.EVENTS) {
                            window.eventBus.emit(window.EVENTS.RECOGNITION_COMPLETED, {
                                jobId: jobId,
                                data: resultData
                            });
                        }
                        
                        // ç›´æ¥åœ¨å†…è”è„šæœ¬ä¸­å¤„ç†ç»“æœï¼Œç»•è¿‡å¯èƒ½è¢«ç¼“å­˜çš„ index.js
                        console.log('=== INLINE: Processing result directly ===');
                        
                        // æå– blocks
                        var blocks = resultData.blocks || (resultData.result && resultData.result.blocks) || [];
                        console.log('INLINE: blocks count:', blocks.length);
                        
                        // æ˜¾ç¤ºæ­¥éª¤4ç•Œé¢
                        showStep4UIInline();
                        
                        // åŠ è½½æ–‡æ¡£å›¾ç‰‡
                        var docImg = document.getElementById('documentImage');
                        if (docImg) {
                            docImg.src = '/api/convert/' + jobId + '/image?t=' + Date.now();
                        }
                        
                        // æ¸²æŸ“ Block åˆ—è¡¨
                        renderBlockListInline(blocks);
                        
                        // ç»˜åˆ¶ OCR åŒºåŸŸæ¡†
                        setTimeout(function() {
                            drawOCRRegionsInline(blocks);
                        }, 300);
                        
                        // æ˜¾ç¤ºç½®ä¿¡åº¦æŠ¥å‘Š
                        if (resultData.confidence_report) {
                            showConfidenceReportInline(resultData.confidence_report);
                        }
                        
                        // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
                        var downloadButtons = document.getElementById('downloadButtons');
                        if (downloadButtons) downloadButtons.style.display = 'flex';
                        
                        // æ·»åŠ ç²¾å‡†ç¼–è¾‘æŒ‰é’®
                        if (window.step4Component && window.step4Component.addPrecisionEditButton) {
                            window.step4Component.addPrecisionEditButton();
                        }
                        
                        // æ˜¾ç¤ºç¡®è®¤æŒ‰é’®
                        var confirmBtn = document.getElementById('confirmStep5Btn');
                        if (confirmBtn) confirmBtn.style.display = 'inline-block';
                        
                        // åŒæ­¥æ•°æ®åˆ° window.appï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        if (window.app) {
                            window.app.currentJobId = jobId;
                            window.app.ocrData = resultData;
                            window.app.ocrRegions = extractOCRRegionsInline(blocks);
                            console.log('INLINE: Synced data to window.app');
                        }
                        
                        // åŒæ­¥æ•°æ®åˆ° stateManagerï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        if (window.stateManager) {
                            window.stateManager.set('jobId', jobId);
                            window.stateManager.set('ocrData', resultData);
                            window.stateManager.set('ocrRegions', extractOCRRegionsInline(blocks));
                        }
                        
                        return; // åœæ­¢è½®è¯¢
                        
                    } else if (data.status === 'failed' || data.status === 'error') {
                        console.error('OCR failed:', data.error);
                        if (statusDiv) {
                            statusDiv.textContent = 'OCR è¯†åˆ«å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯');
                            statusDiv.className = 'status error';
                        }
                        if (window.updateStepStatus) {
                            window.updateStepStatus(3, 'error', 'å¤±è´¥');
                        }
                        return; // åœæ­¢è½®è¯¢
                        
                    } else if (attempt < maxAttempts) {
                        // ç»§ç»­è½®è¯¢
                        if (statusDiv) {
                            statusDiv.textContent = 'OCR è¯†åˆ«å¤„ç†ä¸­...';
                        }
                        setTimeout(poll, pollInterval);
                        
                    } else {
                        // è¶…æ—¶
                        console.error('Polling timeout');
                        if (statusDiv) {
                            statusDiv.textContent = 'OCR å¤„ç†è¶…æ—¶ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
                            statusDiv.className = 'status error';
                        }
                        if (window.updateStepStatus) {
                            window.updateStepStatus(3, 'error', 'è¶…æ—¶');
                        }
                    }
                    
                } catch (error) {
                    console.error('Polling error:', error);
                    if (attempt < maxAttempts) {
                        setTimeout(poll, pollInterval);
                    } else {
                        if (statusDiv) {
                            statusDiv.textContent = 'çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ' + error.message;
                            statusDiv.className = 'status error';
                        }
                    }
                }
            }
            
            // å¼€å§‹è½®è¯¢
            poll();
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initUploadHandler);
        } else {
            // DOM å·²ç»åŠ è½½å®Œæˆ
            initUploadHandler();
        }
        
        // é¢å¤–å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿æ‰€æœ‰æ¨¡å—éƒ½åŠ è½½å®Œæˆ
        setTimeout(initUploadHandler, 500);
        
    })();
    </script>
</body>
</html>
