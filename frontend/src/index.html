<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å¿ƒå•æ®å¤„ç†ç³»ç»Ÿ</title>
    
    <!-- å¤–éƒ¨ä¾èµ– -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- CSS æ¨¡å— -->
    <link rel="stylesheet" href="styles/base.css?v=15">
    <link rel="stylesheet" href="styles/layout.css?v=15">
    <link rel="stylesheet" href="styles/steps.css?v=15">
    <link rel="stylesheet" href="styles/panels.css?v=15">
    <link rel="stylesheet" href="styles/components.css?v=16">
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ä¸­å¿ƒå•æ®å¤„ç†ç³»ç»Ÿ</h1>
            <p>ä¸šåŠ¡å•æ®éç»“æ„åŒ–è§†è§‰ä¿¡æ¯åˆ°ç»“æ„åŒ–ä¸šåŠ¡æ•°æ®çš„ç²¾å‡†è½¬åŒ–å¹³å°</p>
        </div>
        
        <!-- æµç¨‹è¿›åº¦æ¡ + å†å²ç¼“å­˜é¢æ¿ -->
        <div class="workflow-container">
            <!-- å·¦ä¾§ï¼šæµç¨‹æ­¥éª¤ -->
            <div class="workflow-progress">
                <div class="workflow-steps" id="workflowSteps">
                    <div class="workflow-step" id="step1" data-step="1">
                        <div class="step-icon">1</div>
                        <div class="step-label">æ¨¡å‹åŠ è½½</div>
                        <div class="step-time" id="step1Time"></div>
                    </div>
                    <div class="workflow-step" id="step2" data-step="2">
                        <div class="step-icon">2</div>
                        <div class="step-label">ä¸Šä¼ æ–‡ä»¶</div>
                        <div class="step-time" id="step2Time"></div>
                    </div>
                    <div class="workflow-step" id="step3" data-step="3">
                        <div class="step-icon">3</div>
                        <div class="step-label">æ™ºèƒ½è¯†åˆ«</div>
                        <div class="step-time" id="step3Time"></div>
                    </div>
                    <div class="workflow-step" id="step4" data-step="4">
                        <div class="step-icon">4</div>
                        <div class="step-label">é¢„å½•å…¥</div>
                        <div class="step-time" id="step4Time"></div>
                    </div>
                    <div class="workflow-step" id="step5" data-step="5">
                        <div class="step-icon">5</div>
                        <div class="step-label">æ•°æ®æå–</div>
                        <div class="step-time" id="step5Time"></div>
                    </div>
                    <div class="workflow-step" id="step6" data-step="6">
                        <div class="step-icon">6</div>
                        <div class="step-label">è´¢åŠ¡ç¡®è®¤</div>
                        <div class="step-time" id="step6Time"></div>
                    </div>
                </div>
                
                <!-- æœåŠ¡çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                <div class="llm-status-bar" id="llmStatusBar">
                    <div class="llm-status-item" id="llmOcrStatus">
                        <span class="status-dot checking"></span>
                        <span class="status-label">OCRæ¨¡å‹</span>
                        <span class="status-text" id="llmOcrText">æ£€æµ‹ä¸­...</span>
                    </div>
                    <div class="llm-status-item" id="llmLlmStatus">
                        <span class="status-dot checking"></span>
                        <span class="status-label">LLMæœåŠ¡</span>
                        <span class="status-text" id="llmLlmText">æ£€æµ‹ä¸­...</span>
                    </div>
                    <div class="llm-status-item" id="llmRagStatus">
                        <span class="status-dot checking"></span>
                        <span class="status-label">RAGæœåŠ¡</span>
                        <span class="status-text" id="llmRagText">æ£€æµ‹ä¸­...</span>
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šå†å²ç¼“å­˜è®°å½• -->
            <div class="history-panel" id="historyPanel">
                <div class="history-panel-header">
                    <h4>ğŸ“‚ å†å²ç¼“å­˜</h4>
                    <button class="refresh-btn" onclick="window.loadHistoryPanel()" title="åˆ·æ–°">ğŸ”„</button>
                </div>
                <div class="history-panel-list" id="historyPanelList">
                    <div class="history-panel-empty">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
        
        <!-- ä¸Šä¼ åŒºåŸŸ -->
        <div class="upload-section">
            <!-- å•æ®ç±»å‹é€‰æ‹© -->
            <div class="document-type-selector" id="documentTypeSelector">
                <label for="documentTypeSelect">ğŸ“‹ å•æ®ç±»å‹ï¼š</label>
                <select id="documentTypeSelect" class="doc-type-select">
                    <option value="">åŠ è½½ä¸­...</option>
                </select>
                <button id="docTypeConfigBtn" class="doc-type-config-btn" title="å•æ®è®¾å®š">âš™ï¸ è®¾å®š</button>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <p>ğŸ“„ æ‹–æ‹½ PDFã€JPG æˆ– PNG æ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©</p>
                <p><small>æœ€å¤§æ–‡ä»¶: 50MB | æ”¯æŒ: PDF, JPG, PNG</small></p>
            </div>
            <input type="file" id="fileInput" class="file-input" accept=".pdf,.jpg,.jpeg,.png">
            
            <div id="status" class="status"></div>
            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-bar-fill" id="progressBarFill" style="width: 0%"></div>
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content" id="mainContent">
            <!-- å·¦ä¾§ï¼šåŸå§‹å›¾åƒ -->
            <div class="image-panel">
                <div class="image-panel-header">ğŸ“· åŸå§‹æ–‡æ¡£</div>
                <div class="image-container" id="imageContainer">
                    <div class="image-wrapper" id="imageWrapper">
                        <img id="documentImage" src="" alt="Document preview">
                    </div>
                </div>
                <div class="legend">
                    <span class="legend-item"><span class="legend-color normal"></span>è¯†åˆ«åŒºåŸŸ</span>
                    <span class="legend-item"><span class="legend-color hover"></span>æ‚¬åœ</span>
                    <span class="legend-item"><span class="legend-color active"></span>é€‰ä¸­</span>
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šç¼–è¾‘å™¨åŒº -->
            <div class="editor-panel">
                <div class="editor-panel-header">
                    <span>ğŸ“‹ è¯†åˆ«ç»“æœ</span>
                    <div class="edit-mode-toggle" id="editModeToggle">
                        <button id="blockModeBtn" class="mode-btn active" onclick="window.switchViewMode('block')" title="Block è§†å›¾">ğŸ“¦ Block</button>
                        <button id="markdownModeBtn" class="mode-btn" onclick="window.switchViewMode('markdown')" title="Markdown è§†å›¾">ğŸ“ Markdown</button>
                    </div>
                    <!-- æ™ºèƒ½æå–å’Œé—®ç­”æŒ‰é’® -->
                    <div class="smart-buttons" id="smartButtons">
                        <button class="smart-btn extract-btn" id="smartExtractBtn" onclick="window.openSmartExtract && window.openSmartExtract()" title="æ™ºèƒ½æå–å…³é”®ä¿¡æ¯">ğŸ”® æ™ºèƒ½æå–</button>
                        <button class="smart-btn qa-btn" id="smartQaBtn" onclick="window.openDocumentQA && window.openDocumentQA()" title="æ–‡æ¡£é—®ç­”">ğŸ’¬ é—®ç­”</button>
                    </div>
                    <!-- ç¡®è®¤è¿›å…¥æ­¥éª¤5æŒ‰é’® - æ”¾åœ¨æ™ºèƒ½æŒ‰é’®åé¢ -->
                    <button class="confirm-step5-btn" id="confirmStep5Btn" title="ç¡®è®¤é¢„å½•å…¥å®Œæˆï¼Œè¿›å…¥æ•°æ®æå–æ­¥éª¤" style="display: none;">
                        âœ… ç¡®è®¤è¿›å…¥æ­¥éª¤5
                    </button>
                    <div class="download-buttons" id="downloadButtons" style="display: none;">
                        <button class="download-btn" style="background: #e74c3c;" onclick="window.downloadOriginalFile()" title="ä¸‹è½½åŸå§‹ä¸Šä¼ æ–‡ä»¶">ğŸ“„ åŸå§‹æ–‡ä»¶</button>
                        <button class="download-btn" style="background: #17a2b8;" onclick="window.downloadConfidenceLog()" title="ç½®ä¿¡åº¦è®¡ç®—è¯¦ç»†æ—¥å¿—">ğŸ“Š ç½®ä¿¡åº¦LOG</button>
                        <button class="download-btn" style="background: #27ae60;" onclick="window.downloadPPStructure()" title="PPStructure å¸ƒå±€åˆ†æç»“æœ">ğŸ“ å¸ƒå±€JSON</button>
                        <button class="download-btn" style="background: #3498db;" onclick="window.downloadRawOcrJson()" title="æ–‡æœ¬OCRè¯†åˆ«ç»“æœJSON">ğŸ“ OCRç»“æœ</button>
                        <button class="download-btn" style="background: #9b59b6;" onclick="window.downloadRawHtml()" title="HTMLæ ¼å¼è¾“å‡º">ğŸŒ HTML</button>
                        <button class="download-btn" style="background: #6c5ce7;" onclick="window.downloadMarkdown()" title="Markdownæ ¼å¼è¾“å‡º">ğŸ“ MD</button>
                    </div>
                </div>
                <div id="confidenceReport"></div>
                <div class="editor-container">
                    <div id="blockList" class="block-list"></div>
                    <div id="markdownView" class="markdown-view" style="display: none;">
                        <div id="markdownContent" class="markdown-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç¼–è¾‘å¼¹çª—é®ç½© -->
    <div class="edit-overlay" id="editOverlay"></div>
    
    <!-- æ–‡æœ¬ç¼–è¾‘å¼¹çª— -->
    <div class="text-edit-popup" id="textEditPopup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000;">
        <div class="text-edit-header">
            <span>âœï¸ ç¼–è¾‘æ–‡æœ¬</span>
            <button class="close-btn" id="textEditClose">âœ•</button>
        </div>
        <textarea class="text-edit-input" id="textEditInput" placeholder="è¾“å…¥æ–‡æœ¬å†…å®¹..."></textarea>
        <div class="text-edit-footer">
            <button class="cancel-btn" id="textEditCancel">å–æ¶ˆ</button>
            <button class="save-btn" id="textEditSave">ä¿å­˜</button>
        </div>
    </div>
    
    <!-- è¡¨æ ¼ç¼–è¾‘å¼¹çª— -->
    <div class="table-edit-popup" id="tableEditPopup">
        <div class="table-edit-header">
            <h3>ğŸ“Š ç¼–è¾‘è¡¨æ ¼</h3>
            <button id="tableEditClose" style="background:none;border:none;font-size:18px;cursor:pointer;">âœ•</button>
        </div>
        <div class="table-edit-content" id="tableEditContent"></div>
        <div class="table-edit-footer">
            <button class="cancel-btn" id="tableEditCancel">å–æ¶ˆ</button>
            <button class="save-btn" id="tableEditSave">ä¿å­˜</button>
        </div>
    </div>
    
    <!-- å…¨å±€å‡½æ•° -->
    <script src="utils/globalFunctions.js?v=18"></script>
    
    <!-- ä¸»åº”ç”¨ -->
    <script type="module" src="index.js?v=28"></script>
    
    <!-- æ™ºèƒ½æ–‡æ¡£ç†è§£ç»„ä»¶ -->
    <script src="components/SmartExtract.js?v=2"></script>
    <script src="components/DocumentQA.js?v=2"></script>
    <script src="components/ChatOCRIntegration.js?v=2"></script>
    <script src="components/DocumentTypeConfig.js?v=2"></script>
    
    <!-- æ­¥éª¤ç»„ä»¶ -->
    <script type="module">
        import { Step4PreEntry } from './components/steps/Step4PreEntry.js?v=16';
        import { Step5DataExtract } from './components/steps/Step5DataExtract.js?v=16';
        import { Step6Confirmation } from './components/steps/Step6Confirmation.js?v=16';
        
        // æ³¨å†Œåˆ°å…¨å±€
        window.Step4PreEntry = Step4PreEntry;
        window.Step5DataExtract = Step5DataExtract;
        window.Step6Confirmation = Step6Confirmation;
        
        // åˆ›å»ºç»„ä»¶å®ä¾‹
        window.step4Component = new Step4PreEntry(document.body);
        window.step5Component = new Step5DataExtract(document.body);
        window.step6Component = new Step6Confirmation(document.body);
        
        console.log('Step components registered');
    </script>
    
    <!-- åˆå§‹åŒ– -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–å•æ®ç±»å‹é…ç½®
            if (typeof initDocumentTypeConfig === 'function') {
                window.docTypeConfig = initDocumentTypeConfig({ apiBaseUrl: '' });
                console.log('DocumentTypeConfig initialized');
                
                // åŠ è½½å•æ®ç±»å‹åˆ°ä¸‹æ‹‰æ¡†
                loadDocumentTypeSelect();
            }
            
            // å•æ®è®¾å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            var configBtn = document.getElementById('docTypeConfigBtn');
            if (configBtn) {
                configBtn.addEventListener('click', function() {
                    if (window.docTypeConfig) {
                        window.docTypeConfig.show();
                    }
                });
            }
            
            // å•æ®ç±»å‹é€‰æ‹©å˜åŒ–äº‹ä»¶
            var typeSelect = document.getElementById('documentTypeSelect');
            if (typeSelect) {
                typeSelect.addEventListener('change', function() {
                    var selectedTypeId = this.value;
                    if (window.stateManager) {
                        window.stateManager.set('selectedDocumentTypeId', selectedTypeId);
                    }
                    console.log('Selected document type:', selectedTypeId);
                });
            }
            
            // ç›‘å¬è¯†åˆ«å®Œæˆäº‹ä»¶ï¼Œæ˜¾ç¤ºç¡®è®¤æŒ‰é’®
            if (window.eventBus && window.EVENTS) {
                window.eventBus.on(window.EVENTS.RECOGNITION_COMPLETED, function(data) {
                    console.log('=== RECOGNITION_COMPLETED in init script ===');
                    var confirmBtn = document.getElementById('confirmStep5Btn');
                    if (confirmBtn) {
                        confirmBtn.style.display = 'inline-block';
                        console.log('Confirm button shown via init script');
                    }
                });
            }
            
            // ç»‘å®šç¡®è®¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            var confirmBtn = document.getElementById('confirmStep5Btn');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', function() {
                    console.log('Confirm button clicked');
                    
                    // æ›´æ–°æ­¥éª¤çŠ¶æ€
                    if (window.updateStepStatus) {
                        window.updateStepStatus(4, 'completed', 'âœ“');
                        window.updateStepStatus(5, 'active');
                    }
                    
                    // éšè—æŒ‰é’®
                    confirmBtn.style.display = 'none';
                    
                    // éšè—æ­¥éª¤4ç•Œé¢å…ƒç´ 
                    var blockList = document.getElementById('blockList');
                    var imagePanel = document.querySelector('.image-panel');
                    var downloadButtons = document.getElementById('downloadButtons');
                    var confidenceReport = document.getElementById('confidenceReport');
                    var editModeToggle = document.getElementById('editModeToggle');
                    
                    if (blockList) blockList.style.display = 'none';
                    if (imagePanel) imagePanel.style.display = 'none';
                    if (downloadButtons) downloadButtons.style.display = 'none';
                    if (confidenceReport) confidenceReport.style.display = 'none';
                    if (editModeToggle) editModeToggle.style.display = 'none';
                    
                    // éšè— OCR åŒºåŸŸæ ‡è®°
                    document.querySelectorAll('.ocr-region').forEach(function(el) { el.style.display = 'none'; });
                    
                    // æ˜¾ç¤ºæ­¥éª¤5ç•Œé¢
                    if (window.step5Component) {
                        window.step5Component.show();
                        console.log('Step 5 component shown');
                    } else {
                        console.error('Step5 component not found');
                        alert('æ­¥éª¤5ç»„ä»¶æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢');
                    }
                });
                console.log('Confirm button click handler bound');
            }
            
            setTimeout(function() {
                // åˆå§‹åŒ–æ™ºèƒ½åŠŸèƒ½
                if (typeof initChatOCRIntegration === 'function' && window.app) {
                    window.chatOCR = initChatOCRIntegration({ apiBaseUrl: '' });
                    console.log('ChatOCR integration initialized');
                    
                    // ç›‘å¬ jobId å˜åŒ–
                    var originalHandleComplete = window.app.handleProcessingComplete.bind(window.app);
                    window.app.handleProcessingComplete = async function(data, jobId) {
                        await originalHandleComplete(data, jobId);
                        if (window.chatOCR) {
                            window.chatOCR.setJobId(jobId);
                        }
                        // ç¡®ä¿ç¡®è®¤æŒ‰é’®æ˜¾ç¤º
                        var confirmBtn = document.getElementById('confirmStep5Btn');
                        if (confirmBtn) {
                            confirmBtn.style.display = 'inline-block';
                            console.log('Confirm button shown via wrapper');
                        }
                    };
                    
                    if (window.app && window.app.currentJobId) {
                        window.chatOCR.setJobId(window.app.currentJobId);
                    }
                }
            }, 800);
        });
        
        // åŠ è½½å•æ®ç±»å‹åˆ°ä¸‹æ‹‰æ¡†
        async function loadDocumentTypeSelect() {
            var select = document.getElementById('documentTypeSelect');
            if (!select) return;
            
            try {
                var response = await fetch('/api/document-types');
                var data = await response.json();
                
                if (data.success && data.data) {
                    select.innerHTML = data.data.map(function(type) {
                        return '<option value="' + type.id + '">' + type.name + '</option>';
                    }).join('');
                    
                    // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
                    if (data.data.length > 0 && window.stateManager) {
                        window.stateManager.set('selectedDocumentTypeId', data.data[0].id);
                    }
                }
            } catch (error) {
                console.error('Failed to load document types:', error);
                select.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
            }
        }
        
        // åˆ·æ–°å•æ®ç±»å‹ä¸‹æ‹‰æ¡†ï¼ˆä¾›å¤–éƒ¨è°ƒç”¨ï¼‰
        window.refreshDocumentTypeSelect = loadDocumentTypeSelect;
    </script>
</body>
</html>
