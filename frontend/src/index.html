<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFå…¨æ–‡ç»“æ„è¯†åˆ«è¿˜åŸæ¼”ç¤º</title>
    <!-- Marked.js - ä¸“ä¸šçš„Markdownè§£æåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            text-align: center;
        }
        .header h1 {
            margin: 0 0 5px 0;
            font-size: 1.5em;
        }
        .header p {
            margin: 0;
            opacity: 0.8;
            font-size: 0.9em;
        }
        .upload-section {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            background: #fafafa;
        }
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s, background-color 0.3s;
        }
        .upload-area:hover {
            border-color: #3498db;
            background-color: #f0f8ff;
        }
        .upload-area.dragover {
            border-color: #2980b9;
            background-color: #ecf0f1;
        }
        .upload-area p {
            margin: 5px 0;
        }
        .file-input {
            display: none;
        }
        
        /* ä¸»å†…å®¹åŒºåŸŸ - å·¦å³åˆ†æ  */
        .main-content {
            display: none;
            height: calc(100vh - 200px);
            min-height: 500px;
        }
        .main-content.visible {
            display: flex;
        }
        
        /* å·¦ä¾§å›¾åƒé¢„è§ˆåŒº */
        .image-panel {
            flex: 1;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
        }
        .image-panel-header {
            padding: 10px 15px;
            background: #e9ecef;
            border-bottom: 1px solid #ddd;
            font-weight: 600;
            color: #495057;
        }
        .image-container {
            flex: 1;
            overflow: auto;
            padding: 10px;
            position: relative;
        }
        .image-wrapper {
            position: relative;
            display: inline-block;
        }
        #documentImage {
            max-width: 100%;
            height: auto;
            display: block;
        }
        
        /* OCR åŒºåŸŸæ¡† */
        .ocr-region {
            position: absolute;
            border: 2px solid rgba(52, 152, 219, 0.6);
            background: rgba(52, 152, 219, 0.1);
            cursor: pointer;
            transition: all 0.2s;
            overflow: visible;
        }
        .ocr-region:hover {
            border-color: rgba(231, 76, 60, 0.8);
            background: rgba(231, 76, 60, 0.2);
        }
        .ocr-region.active {
            border-color: rgba(46, 204, 113, 0.8);
            background: rgba(46, 204, 113, 0.3);
        }
        .ocr-region-index {
            position: absolute;
            top: 0px;
            left: 0px;
            background: #e74c3c;
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 5px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
            z-index: 101;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            transform: translate(-50%, -50%);
        }
        .ocr-region.active .ocr-region-index {
            background: #27ae60;
        }
        .ocr-region-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            display: none;
            z-index: 100;
        }
        .ocr-region:hover .ocr-region-tooltip {
            display: block;
        }
        
        /* å³ä¾§ç¼–è¾‘å™¨åŒº */
        .editor-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .editor-panel-header {
            padding: 10px 15px;
            background: #e9ecef;
            border-bottom: 1px solid #ddd;
            font-weight: 600;
            color: #495057;
        }
        .editor-container {
            flex: 1;
            overflow: auto;
            padding: 15px;
            position: relative;
        }
        /* åº•å±‚å›¾åƒèƒŒæ™¯ */
        .editor-background-image {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            opacity: 0.15;
            pointer-events: none;
            z-index: 0;
        }
        .editor-background-image img {
            width: 100%;
            height: auto;
        }
        #editor {
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 300px;
            background: rgba(255, 255, 255, 0.85);
            position: relative;
            z-index: 1;
        }
        
        /* Editor.js å—é«˜äº® */
        .ce-block.highlighted {
            background: rgba(46, 204, 113, 0.2);
            border-radius: 4px;
            transition: background 0.3s;
        }
        
        /* çŠ¶æ€æ¶ˆæ¯ */
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.processing {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status.info {
            background-color: #e7f3ff;
            color: #004085;
            border: 1px solid #b8daff;
        }
        .status.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        /* ç½®ä¿¡åº¦æŠ¥å‘Š */
        #confidenceReport {
            margin: 10px 0;
            padding: 12px;
            background: #f0f9ff;
            border-left: 4px solid #3498db;
            border-radius: 4px;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 10px;
        }
        #confidenceReport .confidence-info {
            flex: 1;
            min-width: 200px;
        }
        #confidenceReport h4 {
            margin: 0 0 8px 0;
            color: #2c3e50;
        }
        #confidenceReport p {
            margin: 0 0 8px 0;
            color: #666;
        }
        #confidenceReport ul {
            margin: 5px 0 0 20px;
            padding: 0;
            color: #666;
        }
        .confidence-log-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            white-space: nowrap;
            transition: background 0.2s;
        }
        .confidence-log-btn:hover {
            background: #138496;
        }
        
        /* è¿›åº¦æ¡ */
        .progress-bar {
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-bar-fill {
            height: 100%;
            background: #3498db;
            transition: width 0.3s;
        }
        
        /* å›¾ä¾‹ */
        .legend {
            padding: 8px 15px;
            background: #f8f9fa;
            border-top: 1px solid #ddd;
            font-size: 0.85em;
            color: #666;
        }
        .legend-item {
            display: inline-flex;
            align-items: center;
            margin-right: 15px;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 5px;
        }
        .legend-color.normal {
            background: rgba(52, 152, 219, 0.3);
            border: 2px solid rgba(52, 152, 219, 0.6);
        }
        .legend-color.hover {
            background: rgba(231, 76, 60, 0.3);
            border: 2px solid rgba(231, 76, 60, 0.8);
        }
        .legend-color.active {
            background: rgba(46, 204, 113, 0.3);
            border: 2px solid rgba(46, 204, 113, 0.8);
        }
        
        .editor-panel-header {
            padding: 8px 12px;
            background: #e9ecef;
            border-bottom: 1px solid #ddd;
            font-weight: 600;
            color: #495057;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        /* ä¸‹è½½æŒ‰é’® */
        .download-buttons {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
        }
        .download-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.7em;
            transition: background 0.2s;
            white-space: nowrap;
        }
        .download-btn:hover {
            opacity: 0.85;
        }
        
        /* ç¼–è¾‘æ¨¡å¼åˆ‡æ¢æŒ‰é’® */
        .edit-mode-toggle {
            display: flex;
            gap: 2px;
            background: #ddd;
            border-radius: 4px;
            padding: 2px;
        }
        .mode-btn {
            background: transparent;
            color: #666;
            border: none;
            padding: 3px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.75em;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .mode-btn:hover {
            background: rgba(255,255,255,0.5);
        }
        .mode-btn.active {
            background: white;
            color: #333;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* Markdown è§†å›¾ */
        .markdown-view {
            height: 100%;
            overflow: auto;
        }
        .markdown-content {
            padding: 20px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
            line-height: 1.8;
            color: #333;
        }
        .markdown-content h1 {
            font-size: 1.8em;
            border-bottom: 2px solid #eee;
            padding-bottom: 8px;
            margin: 20px 0 15px 0;
        }
        .markdown-content h2 {
            font-size: 1.5em;
            border-bottom: 1px solid #eee;
            padding-bottom: 6px;
            margin: 18px 0 12px 0;
        }
        .markdown-content h3 {
            font-size: 1.2em;
            margin: 15px 0 10px 0;
        }
        .markdown-content p {
            margin: 10px 0;
        }
        .markdown-content em {
            color: #666;
            font-style: italic;
        }
        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
            font-size: 13px;
        }
        .markdown-content th,
        .markdown-content td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }
        .markdown-content th {
            background: #f5f5f5;
            font-weight: 600;
        }
        .markdown-content tr:nth-child(even) {
            background: #fafafa;
        }
        .markdown-content tr:hover {
            background: #f0f8ff;
        }
        .markdown-content code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
        }
        .markdown-content pre {
            background: #f4f4f4;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .markdown-content blockquote {
            border-left: 4px solid #ddd;
            margin: 10px 0;
            padding: 10px 15px;
            background: #f9f9f9;
            color: #666;
        }
        .markdown-loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }
        
        /* Markdown ç¼–è¾‘å™¨ï¼ˆä¿ç•™å…¼å®¹ï¼‰ */
        .markdown-editor {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .markdown-textarea {
            flex: 1;
            width: 100%;
            min-height: 400px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            background: #fafafa;
        }
        .markdown-textarea:focus {
            outline: none;
            border-color: #3498db;
            background: #fff;
        }
        
        /* æ–‡æœ¬ç¼–è¾‘å¼¹çª— */
        .text-edit-popup {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
            width: 300px;
            z-index: 1000;
            overflow: hidden;
        }
        .text-edit-header {
            padding: 10px 15px;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }
        .text-edit-header .close-btn {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #666;
        }
        .text-edit-header .close-btn:hover {
            color: #333;
        }
        .text-edit-input {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: none;
            border-bottom: 1px solid #eee;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
        }
        .text-edit-input:focus {
            outline: none;
            background: #fffef5;
        }
        .text-edit-footer {
            padding: 10px 15px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        .text-edit-footer button {
            padding: 6px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        .text-edit-footer .save-btn {
            background: #4285f4;
            color: white;
        }
        .text-edit-footer .save-btn:hover {
            background: #3367d6;
        }
        .text-edit-footer .cancel-btn {
            background: #e0e0e0;
            color: #333;
        }
        .text-edit-footer .cancel-btn:hover {
            background: #d0d0d0;
        }
        
        /* å·²ä¿®æ”¹çš„åŒºåŸŸæ ‡è®° */
        .ocr-region.modified {
            border-color: rgba(46, 204, 113, 0.8) !important;
            background: rgba(46, 204, 113, 0.2) !important;
        }
        
        /* Block åˆ—è¡¨æ ·å¼ */
        .block-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .block-item {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .block-item:hover {
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.15);
        }
        .block-item.active {
            border-color: #2ecc71;
            background: rgba(46, 204, 113, 0.08);
            box-shadow: 0 2px 8px rgba(46, 204, 113, 0.2);
        }
        .block-item.modified {
            border-left: 4px solid #2ecc71;
        }
        .block-item.highlight-flash {
            animation: highlightFlash 1s ease-out;
        }
        @keyframes highlightFlash {
            0% { background: rgba(46, 204, 113, 0.4); }
            100% { background: rgba(46, 204, 113, 0.08); }
        }
        .block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .block-type {
            font-size: 0.75em;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .block-type.text { background: #e3f2fd; color: #1976d2; }
        .block-type.title { background: #fff3e0; color: #f57c00; }
        .block-type.table { background: #f3e5f5; color: #7b1fa2; }
        .block-type.figure { background: #e8f5e9; color: #388e3c; }
        .block-type.header { background: #fce4ec; color: #c2185b; }
        .block-type.footer { background: #efebe9; color: #5d4037; }
        /* Edit type badge (TEXT or TABLE) */
        .block-edit-type {
            font-size: 0.7em;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 700;
            text-transform: uppercase;
            margin-right: 6px;
        }
        .block-edit-type.text { background: #2196f3; color: white; }
        .block-edit-type.table { background: #9c27b0; color: white; }
        /* Struct type badge (PPStructureV3 original type) */
        .block-struct-type {
            font-size: 0.7em;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
            background: #f5f5f5;
            color: #666;
            margin-right: auto;
        }
        .block-index {
            font-size: 0.7em;
            color: #999;
        }
        .block-content {
            font-size: 0.9em;
            color: #333;
            line-height: 1.5;
            word-break: break-word;
        }
        .block-content.table-preview {
            overflow-x: auto;
            font-size: 0.8em;
        }
        .block-content.table-preview table {
            border-collapse: collapse;
            width: 100%;
        }
        .block-content.table-preview td,
        .block-content.table-preview th {
            border: 1px solid #ddd;
            padding: 4px 8px;
            text-align: left;
        }
        .block-content.table-preview th {
            background: #f5f5f5;
        }
        .block-meta {
            margin-top: 6px;
            font-size: 0.75em;
            color: #999;
        }
        
        /* ç¼–è¾‘å¼¹çª—é®ç½© */
        .edit-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 999;
            display: none;
        }
        .edit-overlay.visible {
            display: block;
        }
        
        /* è¡¨æ ¼ç¼–è¾‘å¼¹çª— */
        .table-edit-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
            z-index: 1000;
            max-width: 90vw;
            max-height: 80vh;
            display: none;
            flex-direction: column;
            min-width: 500px;
        }
        .table-edit-popup.visible {
            display: flex;
        }
        .table-edit-header {
            padding: 12px 16px;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .table-edit-header h3 {
            margin: 0;
            font-size: 1em;
        }
        .table-edit-content {
            padding: 16px;
            overflow: auto;
            flex: 1;
            max-height: 60vh;
        }
        .table-edit-content table {
            border-collapse: collapse;
            width: 100%;
        }
        .table-edit-content td,
        .table-edit-content th {
            border: 1px solid #ccc;
            padding: 8px;
            min-width: 60px;
        }
        .table-edit-content td[contenteditable="true"],
        .table-edit-content th[contenteditable="true"] {
            outline: none;
            background: #fffef0;
        }
        .table-edit-content td[contenteditable="true"]:focus,
        .table-edit-content th[contenteditable="true"]:focus {
            background: #fff8dc;
            outline: 2px solid #4285f4;
        }
        .table-edit-footer {
            padding: 12px 16px;
            background: #f5f5f5;
            border-top: 1px solid #ddd;
            border-radius: 0 0 8px 8px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        .table-edit-footer button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .table-edit-footer .save-btn {
            background: #4285f4;
            color: white;
        }
        .table-edit-footer .save-btn:hover {
            background: #3367d6;
        }
        .table-edit-footer .cancel-btn {
            background: #e0e0e0;
            color: #333;
        }
        .table-edit-footer .cancel-btn:hover {
            background: #d0d0d0;
        }
        
        /* ========== æµç¨‹è¿›åº¦æ¡ ========== */
        .workflow-container {
            display: flex;
            gap: 20px;
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        .workflow-progress {
            flex: 1;
        }
        .workflow-steps {
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            padding: 0 10px;
        }
        .workflow-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 40px;
            right: 40px;
            height: 3px;
            background: #dee2e6;
            z-index: 0;
        }
        .workflow-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
            cursor: default;
        }
        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #dee2e6;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
            transition: all 0.3s;
            border: 3px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .step-label {
            font-size: 12px;
            color: #6c757d;
            text-align: center;
            max-width: 80px;
            transition: color 0.3s;
        }
        .step-time {
            font-size: 10px;
            color: #adb5bd;
            margin-top: 2px;
        }
        /* æ­¥éª¤çŠ¶æ€ */
        .workflow-step.completed .step-icon {
            background: #28a745;
            color: white;
        }
        .workflow-step.completed .step-label {
            color: #28a745;
        }
        .workflow-step.active .step-icon {
            background: #007bff;
            color: white;
            animation: pulse 1.5s infinite;
        }
        .workflow-step.active .step-label {
            color: #007bff;
            font-weight: 600;
        }
        .workflow-step.waiting .step-icon {
            background: #ffc107;
            color: #212529;
        }
        .workflow-step.waiting .step-label {
            color: #856404;
        }
        .workflow-step.error .step-icon {
            background: #dc3545;
            color: white;
        }
        .workflow-step.error .step-label {
            color: #dc3545;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        /* ========== LLM çŠ¶æ€æŒ‡ç¤ºå™¨ ========== */
        .llm-status-bar {
            display: flex;
            gap: 20px;
            padding: 8px 15px;
            background: #f0f4f8;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 12px;
        }
        .llm-status-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #adb5bd;
        }
        .status-dot.checking {
            background: #ffc107;
            animation: blink 1s infinite;
        }
        .status-dot.online {
            background: #28a745;
        }
        .status-dot.offline {
            background: #dc3545;
        }
        .status-dot.warning {
            background: #fd7e14;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        .status-label {
            color: #495057;
            font-weight: 500;
        }
        .status-text {
            color: #6c757d;
        }
        .status-text.online {
            color: #28a745;
        }
        .status-text.offline {
            color: #dc3545;
        }
        .status-text.warning {
            color: #fd7e14;
        }
        
        /* ========== å³ä¾§å†å²ç¼“å­˜é¢æ¿ ========== */
        .history-panel {
            width: 220px;
            background: white;
            border-left: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .history-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9ecef;
        }
        .history-panel-header h4 {
            margin: 0;
            font-size: 13px;
            color: #495057;
        }
        .history-panel-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .history-panel-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
        }
        .history-panel-item:hover {
            background: #e7f3ff;
            border-color: #007bff;
        }
        .history-panel-item .item-icon {
            font-size: 16px;
        }
        .history-panel-item .item-info {
            flex: 1;
            min-width: 0;
        }
        .history-panel-item .item-name {
            font-weight: 500;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .history-panel-item .item-meta {
            font-size: 10px;
            color: #888;
        }
        .history-panel-item .item-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            background: #d4edda;
            color: #155724;
        }
        .history-panel-item .item-seq {
            font-size: 10px;
            font-weight: 600;
            color: #6c757d;
            min-width: 18px;
        }
        .history-panel-item .item-delete {
            font-size: 12px;
            padding: 2px 5px;
            border: none;
            background: transparent;
            color: #dc3545;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            border-radius: 3px;
        }
        .history-panel-item:hover .item-delete {
            opacity: 1;
        }
        .history-panel-item .item-delete:hover {
            background: #dc3545;
            color: white;
        }
        .history-panel-empty {
            text-align: center;
            color: #888;
            font-size: 12px;
            padding: 20px 10px;
        }
        
        /* æ—§çš„å†å²ä»»åŠ¡åŒºåŸŸ - éšè— */
        .history-section {
            display: none;
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 600;
            color: #495057;
        }
        .refresh-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .refresh-btn:hover {
            background: #e9ecef;
        }
        .history-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .history-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85em;
        }
        .history-item:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }
        .history-item .filename {
            font-weight: 500;
            color: #333;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .history-item .meta {
            color: #888;
            font-size: 0.85em;
        }
        .history-item .confidence {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: 500;
        }
        .history-item .confidence.excellent { background: #d4edda; color: #155724; }
        .history-item .confidence.good { background: #cce5ff; color: #004085; }
        .history-item .confidence.fair { background: #fff3cd; color: #856404; }
        .history-item .confidence.poor { background: #f8d7da; color: #721c24; }
        .history-empty {
            color: #888;
            font-size: 0.9em;
            padding: 10px;
            text-align: center;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>PDFå…¨æ–‡ç»“æ„è¯†åˆ«è¿˜åŸæ¼”ç¤º</h1>
            <p>å°†æ‰«æçš„ PDF æ–‡æ¡£è¯†åˆ«å’Œè¡¨æ ¼è¯†åˆ«æ•´åˆè½¬æ¢ä¸ºå¯ç¼–è¾‘çš„ç½‘é¡µå†…å®¹</p>
        </div>
        
        <!-- ========== æµç¨‹è¿›åº¦æ¡ + å†å²ç¼“å­˜é¢æ¿ ========== -->
        <div class="workflow-container">
            <!-- å·¦ä¾§ï¼šæµç¨‹æ­¥éª¤ -->
            <div class="workflow-progress">
                <div class="workflow-steps" id="workflowSteps">
                    <div class="workflow-step" id="step1" data-step="1">
                        <div class="step-icon">1</div>
                        <div class="step-label">æ¨¡å‹å¯åŠ¨</div>
                        <div class="step-time" id="step1Time"></div>
                    </div>
                    <div class="workflow-step" id="step2" data-step="2">
                        <div class="step-icon">2</div>
                        <div class="step-label">ä¸Šä¼ æ–‡ä»¶</div>
                        <div class="step-time" id="step2Time"></div>
                    </div>
                    <div class="workflow-step" id="step3" data-step="3">
                        <div class="step-icon">3</div>
                        <div class="step-label">è¯†åˆ«å¤„ç†</div>
                        <div class="step-time" id="step3Time"></div>
                    </div>
                    <div class="workflow-step" id="step4" data-step="4">
                        <div class="step-icon">4</div>
                        <div class="step-label">ç»“æœæ˜¾ç¤º</div>
                        <div class="step-time" id="step4Time"></div>
                    </div>
                </div>
                <!-- LLM çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                <div class="llm-status-bar" id="llmStatusBar">
                    <div class="llm-status-item" id="llmOcrStatus">
                        <span class="status-dot checking"></span>
                        <span class="status-label">OCRæ¨¡å‹</span>
                        <span class="status-text" id="llmOcrText">æ£€æµ‹ä¸­...</span>
                    </div>
                    <div class="llm-status-item" id="llmLlmStatus">
                        <span class="status-dot checking"></span>
                        <span class="status-label">LLMæœåŠ¡</span>
                        <span class="status-text" id="llmLlmText">æ£€æµ‹ä¸­...</span>
                    </div>
                    <div class="llm-status-item" id="llmRagStatus">
                        <span class="status-dot checking"></span>
                        <span class="status-label">RAGæœåŠ¡</span>
                        <span class="status-text" id="llmRagText">æ£€æµ‹ä¸­...</span>
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šå†å²ç¼“å­˜è®°å½• -->
            <div class="history-panel" id="historyPanel">
                <div class="history-panel-header">
                    <h4>ğŸ“‚ å†å²ç¼“å­˜</h4>
                    <button class="refresh-btn" onclick="window.loadHistoryPanel()" title="åˆ·æ–°">ğŸ”„</button>
                </div>
                <div class="history-panel-list" id="historyPanelList">
                    <div class="history-panel-empty">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
        
        <!-- å…¨å±€å‡½æ•°å®šä¹‰ -->
        <script>
            // å…¨å±€åŠ è½½å†å²é¢æ¿
            window.loadHistoryPanel = async function() {
                console.log('loadHistoryPanel called');
                var list = document.getElementById('historyPanelList');
                if (!list) { console.error('historyPanelList not found'); return; }
                
                list.innerHTML = '<div class="history-panel-empty">åŠ è½½ä¸­...</div>';
                
                try {
                    var res = await fetch('/api/jobs/history?limit=10');
                    var data = await res.json();
                    console.log('History data:', data);
                    
                    if (data.success && data.jobs && data.jobs.length > 0) {
                        // æŒ‰æ—¶é—´æ’åºï¼šæœ€æ—©çš„åœ¨å‰ï¼ˆåºå·1=æœ€æ—©ï¼‰
                        var sortedJobs = data.jobs.slice().sort(function(a, b) {
                            return a.created_at - b.created_at;
                        });
                        list.innerHTML = sortedJobs.map(function(job, idx) {
                            var seq = idx + 1; // 1 = æœ€æ—©
                            return '<div class="history-panel-item" data-job-id="' + job.job_id + '">' +
                                '<span class="item-seq">' + seq + '</span>' +
                                '<span class="item-icon" onclick="window.loadCachedJob(\'' + job.job_id + '\')">ğŸ“„</span>' +
                                '<div class="item-info" onclick="window.loadCachedJob(\'' + job.job_id + '\')">' +
                                    '<div class="item-name" title="' + job.filename + '">' + job.filename + '</div>' +
                                    '<div class="item-meta">' + Math.round(job.processing_time) + 's</div>' +
                                '</div>' +
                                '<span class="item-badge">' + (job.confidence_score ? Math.round(job.confidence_score * 100) + '%' : '-') + '</span>' +
                                '<button class="item-delete" onclick="event.stopPropagation();window.deleteHistoryJob(\'' + job.job_id + '\')" title="åˆ é™¤">ğŸ—‘</button>' +
                            '</div>';
                        }).join('');
                    } else {
                        list.innerHTML = '<div class="history-panel-empty">æš‚æ— ç¼“å­˜è®°å½•</div>';
                    }
                } catch(e) {
                    console.error('loadHistoryPanel error:', e);
                    list.innerHTML = '<div class="history-panel-empty">åŠ è½½å¤±è´¥</div>';
                }
            };
            
            // åˆ é™¤å•ä¸ªå†å²ç¼“å­˜
            window.deleteHistoryJob = async function(jobId) {
                if (!confirm('ç¡®å®šåˆ é™¤æ­¤ç¼“å­˜è®°å½•ï¼Ÿ')) return;
                try {
                    var res = await fetch('/api/jobs/' + jobId, { method: 'DELETE' });
                    var data = await res.json();
                    if (data.success) {
                        console.log('Deleted job:', jobId);
                        window.loadHistoryPanel(); // åˆ·æ–°åˆ—è¡¨
                    } else {
                        alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch(e) {
                    console.error('Delete error:', e);
                    alert('åˆ é™¤å¤±è´¥: ' + e.message);
                }
            };
            
            // ç»Ÿä¸€æ£€æŸ¥æ‰€æœ‰æœåŠ¡çŠ¶æ€ï¼ˆOCR + LLM + RAGï¼‰
            window.checkAllServicesStatus = async function() {
                console.log('checkAllServicesStatus called');
                
                // ä½¿ç”¨æ–°çš„ç»Ÿä¸€æœåŠ¡çŠ¶æ€æ¥å£
                try {
                    var res = await fetch('/api/services/status');
                    var data = await res.json();
                    console.log('Services status:', data);
                    
                    // OCR çŠ¶æ€
                    if (data.ocr) {
                        if (data.ocr.loaded) {
                            var timeStr = data.ocr.time > 0 ? ' (' + data.ocr.time.toFixed(1) + 's)' : '';
                            window.updateStatusItem('llmOcrStatus', 'llmOcrText', 'online', 'å°±ç»ª' + timeStr);
                        } else if (data.ocr.loading) {
                            window.updateStatusItem('llmOcrStatus', 'llmOcrText', 'checking', 'åŠ è½½ä¸­...');
                        } else {
                            window.updateStatusItem('llmOcrStatus', 'llmOcrText', 'offline', data.ocr.error || 'æœªå°±ç»ª');
                        }
                    }
                    
                    // LLM çŠ¶æ€
                    if (data.llm) {
                        if (data.llm.loaded) {
                            window.updateStatusItem('llmLlmStatus', 'llmLlmText', 'online', 'Ollama');
                        } else if (data.llm.loading) {
                            window.updateStatusItem('llmLlmStatus', 'llmLlmText', 'checking', 'æ£€æµ‹ä¸­...');
                        } else {
                            window.updateStatusItem('llmLlmStatus', 'llmLlmText', 'offline', data.llm.error || 'æœªè¿æ¥');
                        }
                    }
                    
                    // RAG çŠ¶æ€
                    if (data.rag) {
                        if (data.rag.loaded) {
                            var ragTimeStr = data.rag.time > 0 ? ' (' + data.rag.time.toFixed(1) + 's)' : '';
                            window.updateStatusItem('llmRagStatus', 'llmRagText', 'online', 'å°±ç»ª' + ragTimeStr);
                        } else if (data.rag.loading) {
                            window.updateStatusItem('llmRagStatus', 'llmRagText', 'checking', 'åŠ è½½ä¸­...');
                        } else {
                            window.updateStatusItem('llmRagStatus', 'llmRagText', 'warning', data.rag.error || 'æœªå¯ç”¨');
                        }
                    }
                    
                    // å¦‚æœè¿˜æœ‰æœåŠ¡åœ¨åŠ è½½ä¸­ï¼Œç»§ç»­è½®è¯¢
                    if (!data.all_ready) {
                        setTimeout(window.checkAllServicesStatus, 3000);
                    }
                } catch (e) {
                    console.log('Services status check failed:', e.message);
                    // é™çº§åˆ°æ—§æ¥å£
                    window.checkAllServicesStatusFallback();
                }
            };
            
            // é™çº§æ£€æŸ¥ï¼ˆå…¼å®¹æ—§æ¥å£ï¼‰
            window.checkAllServicesStatusFallback = async function() {
                // 1. æ£€æŸ¥ OCR/åç«¯å¥åº·çŠ¶æ€
                try {
                    var healthRes = await fetch('/api/health');
                    var healthData = await healthRes.json();
                    if (healthData.status === 'healthy') {
                        window.updateStatusItem('llmOcrStatus', 'llmOcrText', 'online', 'å°±ç»ª');
                    } else {
                        window.updateStatusItem('llmOcrStatus', 'llmOcrText', 'warning', 'åŠ è½½ä¸­');
                    }
                } catch (e) {
                    window.updateStatusItem('llmOcrStatus', 'llmOcrText', 'offline', 'ç¦»çº¿');
                }
                
                // 2. æ£€æŸ¥ LLM + RAG çŠ¶æ€
                try {
                    var llmRes = await fetch('/api/llm/status');
                    var llmData = await llmRes.json();
                    
                    if (llmData.success && llmData.data) {
                        var d = llmData.data;
                        if (d.llm_available) {
                            window.updateStatusItem('llmLlmStatus', 'llmLlmText', 'online', d.model || 'Ollama');
                        } else {
                            window.updateStatusItem('llmLlmStatus', 'llmLlmText', 'offline', 'æœªè¿æ¥');
                        }
                        if (d.rag_available) {
                            window.updateStatusItem('llmRagStatus', 'llmRagText', 'online', 'å°±ç»ª');
                        } else {
                            window.updateStatusItem('llmRagStatus', 'llmRagText', 'warning', 'æœªå¯ç”¨');
                        }
                    } else {
                        window.updateStatusItem('llmLlmStatus', 'llmLlmText', 'offline', 'ä¸å¯ç”¨');
                        window.updateStatusItem('llmRagStatus', 'llmRagText', 'offline', 'ä¸å¯ç”¨');
                    }
                } catch (e) {
                    window.updateStatusItem('llmLlmStatus', 'llmLlmText', 'offline', 'æ£€æµ‹å¤±è´¥');
                    window.updateStatusItem('llmRagStatus', 'llmRagText', 'offline', 'æ£€æµ‹å¤±è´¥');
                }
            };
            
            // æ›´æ–°çŠ¶æ€é¡¹
            window.updateStatusItem = function(itemId, textId, status, text) {
                var item = document.getElementById(itemId);
                var textEl = document.getElementById(textId);
                if (!item || !textEl) return;
                
                var dot = item.querySelector('.status-dot');
                if (dot) {
                    dot.classList.remove('checking', 'online', 'offline', 'warning');
                    dot.classList.add(status);
                }
                textEl.classList.remove('online', 'offline', 'warning');
                textEl.classList.add(status);
                textEl.textContent = text;
            };
            
            // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æŸ¥
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(function() {
                    window.loadHistoryPanel();
                    window.checkAllServicesStatus();
                }, 200);
            });
            
            // å½“å‰è§†å›¾æ¨¡å¼
            window.currentViewMode = 'block';
            window.markdownCache = null;
            
            // åˆ‡æ¢è§†å›¾æ¨¡å¼
            window.switchViewMode = async function(mode) {
                console.log('Switching view mode to:', mode);
                window.currentViewMode = mode;
                
                var blockBtn = document.getElementById('blockModeBtn');
                var mdBtn = document.getElementById('markdownModeBtn');
                var blockList = document.getElementById('blockList');
                var mdView = document.getElementById('markdownView');
                var ocrRegions = document.querySelectorAll('.ocr-region');
                
                if (mode === 'block') {
                    blockBtn.classList.add('active');
                    mdBtn.classList.remove('active');
                    blockList.style.display = 'flex';
                    mdView.style.display = 'none';
                    // æ˜¾ç¤ºOCRåŒºåŸŸæ¡†
                    ocrRegions.forEach(function(r) { r.style.display = 'block'; });
                } else {
                    blockBtn.classList.remove('active');
                    mdBtn.classList.add('active');
                    blockList.style.display = 'none';
                    mdView.style.display = 'block';
                    // éšè—OCRåŒºåŸŸæ¡†ï¼ˆMarkdownæ¨¡å¼ä¸‹ä¸æ”¯æŒå®šä½ï¼‰
                    ocrRegions.forEach(function(r) { r.style.display = 'none'; });
                    
                    // åŠ è½½Markdownå†…å®¹
                    await window.loadMarkdownView();
                }
            };
            
            // åŠ è½½Markdownè§†å›¾
            window.loadMarkdownView = async function() {
                var jobId = window.app ? window.app.currentJobId : null;
                var mdContent = document.getElementById('markdownContent');
                
                if (!jobId) {
                    mdContent.innerHTML = '<div class="markdown-loading">è¯·å…ˆä¸Šä¼ æ–‡ä»¶æˆ–é€‰æ‹©å†å²ä»»åŠ¡</div>';
                    return;
                }
                
                // å¦‚æœæœ‰ç¼“å­˜ä¸”æ˜¯åŒä¸€ä¸ªjobï¼Œç›´æ¥ä½¿ç”¨
                if (window.markdownCache && window.markdownCache.jobId === jobId) {
                    mdContent.innerHTML = window.markdownCache.html;
                    return;
                }
                
                mdContent.innerHTML = '<div class="markdown-loading">â³ åŠ è½½Markdownä¸­...</div>';
                
                try {
                    var res = await fetch('/api/convert/' + jobId + '/markdown');
                    var data = await res.json();
                    
                    if (data.markdown) {
                        // ç®€å•çš„Markdownæ¸²æŸ“
                        var html = window.renderMarkdown(data.markdown);
                        mdContent.innerHTML = html;
                        
                        // ç¼“å­˜
                        window.markdownCache = { jobId: jobId, html: html, raw: data.markdown };
                    } else {
                        mdContent.innerHTML = '<div class="markdown-loading">âŒ Markdownä¸å¯ç”¨</div>';
                    }
                } catch(e) {
                    console.error('Load markdown error:', e);
                    mdContent.innerHTML = '<div class="markdown-loading">âŒ åŠ è½½å¤±è´¥: ' + e.message + '</div>';
                }
            };
            
            // ä½¿ç”¨ marked.js æ¸²æŸ“Markdown
            window.renderMarkdown = function(md) {
                if (typeof marked !== 'undefined') {
                    // é…ç½® marked é€‰é¡¹
                    marked.setOptions({
                        gfm: true,        // GitHubé£æ ¼Markdown
                        breaks: true,     // æ¢è¡Œè½¬<br>
                        tables: true      // æ”¯æŒè¡¨æ ¼
                    });
                    return marked.parse(md);
                } else {
                    // å›é€€åˆ°ç®€å•æ¸²æŸ“
                    return '<pre>' + md.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</pre>';
                }
            };
            
            // ä¸‹è½½Markdownæ–‡ä»¶
            window.downloadMarkdown = async function() {
                var jobId = window.app ? window.app.currentJobId : null;
                if (!jobId) { alert('æ— ä»»åŠ¡ID'); return; }
                
                try {
                    // å¦‚æœæœ‰ç¼“å­˜ï¼Œç›´æ¥ä½¿ç”¨
                    if (window.markdownCache && window.markdownCache.jobId === jobId && window.markdownCache.raw) {
                        var blob = new Blob([window.markdownCache.raw], {type: 'text/markdown'});
                        var a = document.createElement('a');
                        a.href = URL.createObjectURL(blob);
                        a.download = 'ocr-result-' + jobId + '.md';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        return;
                    }
                    
                    var res = await fetch('/api/convert/' + jobId + '/markdown');
                    var data = await res.json();
                    if (data.markdown) {
                        var blob = new Blob([data.markdown], {type: 'text/markdown'});
                        var a = document.createElement('a');
                        a.href = URL.createObjectURL(blob);
                        a.download = 'ocr-result-' + jobId + '.md';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    } else {
                        alert('Markdownä¸å¯ç”¨');
                    }
                } catch(e) {
                    alert('ä¸‹è½½å¤±è´¥: ' + e.message);
                }
            };
            
            // å…¨å±€ä¸‹è½½å‡½æ•° - ç½®ä¿¡åº¦LOG
            window.downloadConfidenceLog = async function() {
                var jobId = window.app ? window.app.currentJobId : null;
                if (!jobId) { alert('æ— ä»»åŠ¡ID'); return; }
                try {
                    var res = await fetch('/api/convert/' + jobId + '/confidence-log');
                    var data = await res.json();
                    if (data.confidence_log) {
                        var blob = new Blob([data.confidence_log], {type: 'text/markdown'});
                        var a = document.createElement('a');
                        a.href = URL.createObjectURL(blob);
                        a.download = 'confidence-log-' + jobId + '.md';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    } else {
                        alert('é”™è¯¯: ' + (data.error || 'æ—¥å¿—ä¸å¯ç”¨'));
                    }
                } catch(e) {
                    alert('ä¸‹è½½å¤±è´¥: ' + e.message);
                }
            };
            
            // å…¨å±€ä¸‹è½½å‡½æ•° - å¸ƒå±€JSON
            window.downloadPPStructure = async function() {
                var jobId = window.app ? window.app.currentJobId : null;
                if (!jobId) { alert('æ— ä»»åŠ¡ID'); return; }
                try {
                    var res = await fetch('/api/convert/' + jobId + '/raw-output');
                    var data = await res.json();
                    if (data.ppstructure_json) {
                        var blob = new Blob([JSON.stringify(data.ppstructure_json, null, 2)], {type: 'application/json'});
                        var a = document.createElement('a');
                        a.href = URL.createObjectURL(blob);
                        a.download = 'ppstructure-' + jobId + '.json';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    } else {
                        alert('é”™è¯¯: å¸ƒå±€JSONä¸å¯ç”¨');
                    }
                } catch(e) { alert('ä¸‹è½½å¤±è´¥: ' + e.message); }
            };
            
            // å…¨å±€ä¸‹è½½å‡½æ•° - åŸå§‹æ–‡ä»¶
            window.downloadOriginalFile = async function() {
                var jobId = window.app ? window.app.currentJobId : null;
                if (!jobId) { alert('æ— ä»»åŠ¡ID'); return; }
                try {
                    var res = await fetch('/api/convert/' + jobId + '/original-file');
                    if (!res.ok) {
                        var errData = await res.json();
                        alert('é”™è¯¯: ' + (errData.error || 'ä¸‹è½½å¤±è´¥'));
                        return;
                    }
                    // ä» Content-Disposition è·å–æ–‡ä»¶å
                    var contentDisposition = res.headers.get('Content-Disposition');
                    var filename = 'original-' + jobId;
                    if (contentDisposition) {
                        var match = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                        if (match && match[1]) {
                            filename = match[1].replace(/['"]/g, '');
                        }
                    }
                    var blob = await res.blob();
                    var a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(a.href);
                } catch(e) {
                    console.error('Download original file error:', e);
                    alert('ä¸‹è½½å¤±è´¥: ' + e.message);
                }
            };
            
            // å…¨å±€ä¸‹è½½å‡½æ•° - OCRç»“æœJSON
            window.downloadRawOcrJson = async function() {
                var jobId = window.app ? window.app.currentJobId : null;
                if (!jobId) { alert('æ— ä»»åŠ¡ID'); return; }
                try {
                    var res = await fetch('/api/convert/' + jobId + '/raw-output');
                    var data = await res.json();
                    if (data.raw_json) {
                        var blob = new Blob([JSON.stringify(data.raw_json, null, 2)], {type: 'application/json'});
                        var a = document.createElement('a');
                        a.href = URL.createObjectURL(blob);
                        a.download = 'raw-ocr-' + jobId + '.json';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    } else {
                        alert('é”™è¯¯: OCRç»“æœJSONä¸å¯ç”¨');
                    }
                } catch(e) { alert('ä¸‹è½½å¤±è´¥: ' + e.message); }
            };
            
            // å…¨å±€ä¸‹è½½å‡½æ•° - HTMLç»“æœ
            window.downloadRawHtml = async function() {
                var jobId = window.app ? window.app.currentJobId : null;
                if (!jobId) { alert('æ— ä»»åŠ¡ID'); return; }
                try {
                    var res = await fetch('/api/convert/' + jobId + '/raw-output');
                    var data = await res.json();
                    if (data.raw_html) {
                        var blob = new Blob([data.raw_html], {type: 'text/html'});
                        var a = document.createElement('a');
                        a.href = URL.createObjectURL(blob);
                        a.download = 'raw-ocr-' + jobId + '.html';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    } else {
                        alert('é”™è¯¯: HTMLç»“æœä¸å¯ç”¨');
                    }
                } catch(e) { alert('ä¸‹è½½å¤±è´¥: ' + e.message); }
            };
            
            // æµ‹è¯•å†å²ä»»åŠ¡API
            window.testJobHistory = async function() {
                console.log('Testing job history API...');
                try {
                    var res = await fetch('/api/jobs/history?limit=10');
                    console.log('Response status:', res.status);
                    var data = await res.json();
                    console.log('Response data:', data);
                    if (data.success && data.jobs && data.jobs.length > 0) {
                        alert('âœ… APIæ­£å¸¸ï¼æ‰¾åˆ° ' + data.jobs.length + ' ä¸ªå†å²ä»»åŠ¡:\n\n' + 
                            data.jobs.map(function(j) { return j.filename + ' (' + j.processing_time + 's)'; }).join('\n'));
                        // æ˜¾ç¤ºå†å²åŒºåŸŸ
                        var section = document.getElementById('historySection');
                        if (section) section.style.display = 'block';
                        // æ¸²æŸ“åˆ—è¡¨
                        var list = document.getElementById('historyList');
                        if (list) {
                            list.innerHTML = data.jobs.map(function(job) {
                                return '<div class="history-item" onclick="window.loadCachedJob(\'' + job.job_id + '\')">' +
                                    '<span class="filename">' + job.filename + '</span>' +
                                    '<span class="meta">' + job.processing_time + 's</span>' +
                                    '<span class="confidence">' + (job.confidence_score ? Math.round(job.confidence_score * 100) + '%' : '-') + '</span>' +
                                    '</div>';
                            }).join('');
                        }
                    } else {
                        alert('âš ï¸ æ²¡æœ‰å†å²ä»»åŠ¡');
                    }
                } catch(e) {
                    console.error('Error:', e);
                    alert('âŒ APIè°ƒç”¨å¤±è´¥: ' + e.message);
                }
            };
            
            // è°ƒè¯•OCRåŒºåŸŸç»˜åˆ¶
            window.debugOCRRegions = function() {
                var img = document.getElementById('documentImage');
                var wrapper = document.getElementById('imageWrapper');
                
                console.log('=== OCRåŒºåŸŸè°ƒè¯• ===');
                console.log('img.naturalWidth:', img ? img.naturalWidth : 'N/A');
                console.log('img.naturalHeight:', img ? img.naturalHeight : 'N/A');
                console.log('img.clientWidth:', img ? img.clientWidth : 'N/A');
                console.log('img.clientHeight:', img ? img.clientHeight : 'N/A');
                console.log('wrapper.clientWidth:', wrapper ? wrapper.clientWidth : 'N/A');
                console.log('wrapper.clientHeight:', wrapper ? wrapper.clientHeight : 'N/A');
                
                if (img) {
                    var scaleX = img.clientWidth / img.naturalWidth;
                    var scaleY = img.clientHeight / img.naturalHeight;
                    console.log('scaleX:', scaleX);
                    console.log('scaleY:', scaleY);
                }
                
                var info = '=== OCRåŒºåŸŸè°ƒè¯• ===\n';
                if (img) {
                    info += 'naturalSize: ' + img.naturalWidth + 'x' + img.naturalHeight + '\n';
                    info += 'clientSize: ' + img.clientWidth + 'x' + img.clientHeight + '\n';
                    var scaleX = img.clientWidth / img.naturalWidth;
                    var scaleY = img.clientHeight / img.naturalHeight;
                    info += 'scaleX: ' + scaleX.toFixed(4) + '\n';
                    info += 'scaleY: ' + scaleY.toFixed(4) + '\n';
                    
                    // æ£€æŸ¥å›¾ç‰‡åœ¨ wrapper ä¸­çš„åç§»
                    var imgRect = img.getBoundingClientRect();
                    var wrapperRect = wrapper.getBoundingClientRect();
                    info += '\nimg offset in wrapper:\n';
                    info += '  left: ' + (imgRect.left - wrapperRect.left) + 'px\n';
                    info += '  top: ' + (imgRect.top - wrapperRect.top) + 'px\n';
                }
                if (wrapper) {
                    info += 'wrapperSize: ' + wrapper.clientWidth + 'x' + wrapper.clientHeight + '\n';
                }
                
                var regions = document.querySelectorAll('.ocr-region');
                info += 'regions: ' + regions.length + '\n';
                info += 'indexLabels: ' + document.querySelectorAll('.ocr-region-index').length + '\n';
                
                if (window.app && window.app.ocrRegions && window.app.ocrRegions.length > 0) {
                    var r0 = window.app.ocrRegions[0];
                    info += '\nåŸå§‹åæ ‡#1: x=' + r0.coordinates.x + ', y=' + r0.coordinates.y + '\n';
                    info += 'åŸå§‹å°ºå¯¸#1: w=' + r0.coordinates.width + ', h=' + r0.coordinates.height + '\n';
                }
                
                if (regions.length > 0) {
                    info += '\nDOM#1: left=' + regions[0].style.left + ', top=' + regions[0].style.top + '\n';
                    info += 'DOM#1: w=' + regions[0].style.width + ', h=' + regions[0].style.height + '\n';
                    
                    // æ£€æŸ¥å®é™…æ¸²æŸ“ä½ç½®
                    var r0Rect = regions[0].getBoundingClientRect();
                    var wrapperRect = wrapper.getBoundingClientRect();
                    info += '\nå®é™…æ¸²æŸ“ä½ç½®#1:\n';
                    info += '  ç›¸å¯¹wrapper left: ' + (r0Rect.left - wrapperRect.left).toFixed(1) + 'px\n';
                    info += '  ç›¸å¯¹wrapper top: ' + (r0Rect.top - wrapperRect.top).toFixed(1) + 'px\n';
                }
                
                alert(info);
            };
            
            // åŠ è½½ç¼“å­˜ä»»åŠ¡
            window.loadCachedJob = async function(jobId) {
                console.log('Loading cached job:', jobId);
                try {
                    var res = await fetch('/api/jobs/' + jobId + '/cached-result');
                    var data = await res.json();
                    console.log('Cached result:', data);
                    if (data.status === 'completed' && data.result) {
                        console.log('âœ… ç¼“å­˜åŠ è½½æˆåŠŸï¼blocks: ' + data.result.blocks.length);
                        // è½¬æ¢ä¸ºä¸å®æ—¶å¤„ç†ä¸€è‡´çš„æ ¼å¼
                        if (window.app) {
                            var processedData = {
                                blocks: data.result.blocks,
                                confidence_report: data.confidence_report,
                                markdown: data.markdown,
                                cached: true
                            };
                            await window.app.handleProcessingComplete(processedData, jobId);
                        }
                    } else {
                        alert('âŒ åŠ è½½å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch(e) {
                    console.error('Error:', e);
                    alert('âŒ åŠ è½½å¤±è´¥: ' + e.message);
                }
            };
        </script>
        
        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <p>ğŸ“„ æ‹–æ‹½ PDFã€JPG æˆ– PNG æ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©</p>
                <p><small>æœ€å¤§æ–‡ä»¶: 10MB | æ”¯æŒ: PDF, JPG, PNG</small></p>
            </div>
            <input type="file" id="fileInput" class="file-input" accept=".pdf,.jpg,.jpeg,.png">
            
            <div id="status" class="status"></div>
            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-bar-fill" id="progressBarFill" style="width: 0%"></div>
            </div>
        </div>
        
        <div class="main-content" id="mainContent">
            <!-- å·¦ä¾§ï¼šåŸå§‹å›¾åƒ -->
            <div class="image-panel">
                <div class="image-panel-header">ğŸ“· åŸå§‹æ–‡æ¡£</div>
                <div class="image-container" id="imageContainer">
                    <div class="image-wrapper" id="imageWrapper">
                        <img id="documentImage" src="" alt="Document preview">
                        <!-- OCR åŒºåŸŸæ¡†å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                    </div>
                </div>
                <div class="legend">
                    <span class="legend-item"><span class="legend-color normal"></span>è¯†åˆ«åŒºåŸŸ</span>
                    <span class="legend-item"><span class="legend-color hover"></span>æ‚¬åœ</span>
                    <span class="legend-item"><span class="legend-color active"></span>é€‰ä¸­</span>
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šBlock åˆ—è¡¨ -->
            <div class="editor-panel">
                <div class="editor-panel-header">
                    <span>ğŸ“‹ è¯†åˆ«ç»“æœ</span>
                    <div class="edit-mode-toggle" id="editModeToggle">
                        <button id="blockModeBtn" class="mode-btn active" onclick="window.switchViewMode('block')" title="Block è§†å›¾">ğŸ“¦ Block</button>
                        <button id="markdownModeBtn" class="mode-btn" onclick="window.switchViewMode('markdown')" title="Markdown è§†å›¾">ğŸ“ Markdown</button>
                    </div>
                    <div class="download-buttons" id="downloadButtons" style="display: none;">
                        <button class="download-btn" style="background: #e74c3c;" onclick="window.downloadOriginalFile()" title="ä¸‹è½½åŸå§‹ä¸Šä¼ æ–‡ä»¶">ğŸ“„ åŸå§‹æ–‡ä»¶</button>
                        <button class="download-btn" style="background: #17a2b8;" onclick="window.downloadConfidenceLog()" title="ç½®ä¿¡åº¦è®¡ç®—è¯¦ç»†æ—¥å¿—">ğŸ“Š ç½®ä¿¡åº¦LOG</button>
                        <button class="download-btn" style="background: #27ae60;" onclick="window.downloadPPStructure()" title="PPStructure å¸ƒå±€åˆ†æç»“æœ">ğŸ“ å¸ƒå±€JSON</button>
                        <button class="download-btn" style="background: #3498db;" onclick="window.downloadRawOcrJson()" title="æ–‡æœ¬OCRè¯†åˆ«ç»“æœJSON">ğŸ“ OCRç»“æœ</button>
                        <button class="download-btn" style="background: #9b59b6;" onclick="window.downloadRawHtml()" title="HTMLæ ¼å¼è¾“å‡º">ğŸŒ HTML</button>
                        <button class="download-btn" style="background: #6c5ce7;" onclick="window.downloadMarkdown()" title="Markdownæ ¼å¼è¾“å‡º">ğŸ“ MD</button>
                    </div>
                </div>
                <div id="confidenceReport"></div>
                <div class="editor-container">
                    <div id="blockList" class="block-list">
                        <!-- Block åˆ—è¡¨å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                    </div>
                    <div id="markdownView" class="markdown-view" style="display: none;">
                        <div id="markdownContent" class="markdown-content">
                            <!-- Markdown æ¸²æŸ“å†…å®¹ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç¼–è¾‘å¼¹çª—é®ç½© -->
    <div class="edit-overlay" id="editOverlay"></div>
    
    <!-- æ–‡æœ¬ç¼–è¾‘å¼¹çª— -->
    <div class="text-edit-popup" id="textEditPopup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000;">
        <div class="text-edit-header">
            <span>âœï¸ ç¼–è¾‘æ–‡æœ¬</span>
            <button class="close-btn" id="textEditClose">âœ•</button>
        </div>
        <textarea class="text-edit-input" id="textEditInput" placeholder="è¾“å…¥æ–‡æœ¬å†…å®¹..."></textarea>
        <div class="text-edit-footer">
            <button class="cancel-btn" id="textEditCancel">å–æ¶ˆ</button>
            <button class="save-btn" id="textEditSave">ä¿å­˜</button>
        </div>
    </div>
    
    <!-- è¡¨æ ¼ç¼–è¾‘å¼¹çª— -->
    <div class="table-edit-popup" id="tableEditPopup">
        <div class="table-edit-header">
            <h3>ğŸ“Š ç¼–è¾‘è¡¨æ ¼</h3>
            <button id="tableEditClose" style="background:none;border:none;font-size:18px;cursor:pointer;">âœ•</button>
        </div>
        <div class="table-edit-content" id="tableEditContent">
            <!-- è¡¨æ ¼å†…å®¹å°†åŠ¨æ€æ’å…¥ -->
        </div>
        <div class="table-edit-footer">
            <button class="cancel-btn" id="tableEditCancel">å–æ¶ˆ</button>
            <button class="save-btn" id="tableEditSave">ä¿å­˜</button>
        </div>
    </div>
    
    <script type="module" src="index.js"></script>
    
    <!-- æ™ºèƒ½æ–‡æ¡£ç†è§£ç»„ä»¶ -->
    <script src="components/SmartExtract.js"></script>
    <script src="components/DocumentQA.js"></script>
    <script src="components/ChatOCRIntegration.js"></script>
    
    <!-- åˆå§‹åŒ–æ™ºèƒ½åŠŸèƒ½ -->
    <script>
        // ç­‰å¾… App åˆå§‹åŒ–ååˆå§‹åŒ–æ™ºèƒ½åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                if (typeof initChatOCRIntegration === 'function') {
                    window.chatOCR = initChatOCRIntegration({ apiBaseUrl: '' });
                    console.log('ChatOCR integration initialized');
                    
                    // ç›‘å¬ jobId å˜åŒ–
                    var originalHandleComplete = window.app.handleProcessingComplete.bind(window.app);
                    window.app.handleProcessingComplete = async function(data, jobId) {
                        await originalHandleComplete(data, jobId);
                        if (window.chatOCR) {
                            window.chatOCR.setJobId(jobId);
                        }
                    };
                    
                    // å¦‚æœå·²æœ‰ jobIdï¼Œè®¾ç½®å®ƒ
                    if (window.app && window.app.currentJobId) {
                        window.chatOCR.setJobId(window.app.currentJobId);
                    }
                }
            }, 600);
        });
    </script>
    
    <!-- ä¿®å¤ï¼šè¦†ç›– drawOCRRegions æ·»åŠ åºå·æ ‡ç­¾ -->
    <script>
        // ç­‰å¾… App åˆå§‹åŒ–åè¦†ç›– drawOCRRegions
        setTimeout(function() {
            if (window.app) {
                console.log('Patching drawOCRRegions to add index labels...');
                var originalDraw = window.app.drawOCRRegions.bind(window.app);
                window.app.drawOCRRegions = function() {
                    var wrapper = document.getElementById('imageWrapper');
                    var img = document.getElementById('documentImage');
                    if (!wrapper || !img || !img.naturalWidth) {
                        console.log('drawOCRRegions: image not ready');
                        return;
                    }
                    wrapper.querySelectorAll('.ocr-region').forEach(function(el) { el.remove(); });
                    var scaleX = img.clientWidth / img.naturalWidth;
                    var scaleY = img.clientHeight / img.naturalHeight;
                    console.log('drawOCRRegions (patched): scale', scaleX, scaleY);
                    var self = window.app;
                    self.ocrRegions.forEach(function(region, idx) {
                        if (!region.hasCoordinates) return;
                        var c = region.coordinates;
                        var div = document.createElement('div');
                        div.className = 'ocr-region';
                        div.setAttribute('data-region-index', idx);
                        div.setAttribute('data-region-type', region.type);
                        div.style.left = (c.x * scaleX) + 'px';
                        div.style.top = (c.y * scaleY) + 'px';
                        div.style.width = (c.width * scaleX) + 'px';
                        div.style.height = (c.height * scaleY) + 'px';
                        // æ·»åŠ åºå·æ ‡ç­¾
                        var indexLabel = document.createElement('span');
                        indexLabel.className = 'ocr-region-index';
                        indexLabel.textContent = '#' + (idx + 1);
                        div.appendChild(indexLabel);
                        // tooltip
                        var tip = document.createElement('div');
                        tip.className = 'ocr-region-tooltip';
                        var mod = self.modifications.get(idx);
                        var txt = mod ? mod.text : region.text;
                        tip.textContent = txt.length > 30 ? txt.substring(0,30) + '...' : txt;
                        div.appendChild(tip);
                        div.addEventListener('click', function(e) { e.stopPropagation(); self.selectRegion(idx); });
                        div.addEventListener('dblclick', function(e) { e.stopPropagation(); self.startEditRegion(idx); });
                        if (self.modifications.has(idx)) div.classList.add('modified');
                        wrapper.appendChild(div);
                    });
                    console.log('drawOCRRegions (patched): created', self.ocrRegions.length, 'regions with index labels');
                };
                console.log('drawOCRRegions patched successfully!');
            }
        }, 500);
    </script>
</body>
</html>
