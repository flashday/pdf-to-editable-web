# React + Markdown 精准作业台 - 需求文档

## 功能概述

构建一个基于 React 的"精准作业台"（Precision Workbench），实现 PDF 原文与 Markdown 编辑器的双栏对照界面，支持 OCR 结果的精准修正。采用渐进式迁移策略，在现有步骤4"预录入"界面基础上，新增"精准编辑模式"入口。

## 用户故事

### 1. 模式切换

#### 1.1 进入精准编辑模式
作为财务人员，我希望在步骤4预录入界面看到"切换到精准编辑模式"按钮，以便选择更专业的编辑方式。

**验收标准：**
- 步骤4界面顶部显示"🎯 精准编辑模式"按钮
- 点击按钮后跳转到独立的 React 编辑器页面
- 传递当前 jobId 到新页面
- 新页面加载完成后显示双栏布局

#### 1.2 返回传统模式
作为用户，我希望能从精准编辑模式返回传统模式，以便在两种模式间自由切换。

**验收标准：**
- 精准编辑模式界面有"返回传统模式"按钮
- 点击后返回步骤4传统界面
- 编辑内容自动保存，不丢失

### 2. PDF 渲染与 Bounding Box

#### 2.1 PDF 文档渲染
作为用户，我希望在左侧面板看到清晰的 PDF 原文，以便对照修正。

**验收标准：**
- 左侧面板渲染 PDF 第一页图像
- 支持缩放（50%-200%）
- 支持拖拽平移
- 渲染性能流畅（FPS > 30）

#### 2.2 OCR 区域高亮
作为用户，我希望看到 OCR 识别的每个区域边框，以便了解识别范围。

**验收标准：**
- 在 PDF 上叠加半透明的 Bounding Box
- 每个 Box 对应一个 OCR Block
- 鼠标悬停时显示 Block 类型（text/table/title）
- 当前选中的 Block 边框高亮（蓝色）

#### 2.3 置信度告警
作为用户，我希望低置信度区域有明显标识，以便重点校验。

**验收标准：**
- 置信度 < 0.9 的 Block 边框显示为红色
- 置信度 < 0.8 的 Block 边框显示为橙色并闪烁
- 鼠标悬停显示具体置信度数值

### 3. Markdown 编辑器

#### 3.1 Markdown 内容加载
作为用户，我希望右侧编辑器自动加载 OCR 识别的 Markdown 内容。

**验收标准：**
- 自动加载 `{jobId}_raw_ocr.md` 内容
- 支持所见即所得编辑模式
- 支持源码编辑模式切换
- 正确渲染标题、段落、列表、表格

#### 3.2 表格编辑
作为用户，我希望能直接编辑表格内容，包括复杂的合并单元格。

**验收标准：**
- 支持 Markdown 表格语法
- 支持 HTML 表格混合渲染
- 可直接在单元格内修改文字
- 支持添加/删除行列

#### 3.3 内容保存
作为用户，我希望编辑后的内容能自动保存。

**验收标准：**
- 支持手动保存（Ctrl+S）
- 支持自动保存（编辑后 3 秒无操作）
- 保存时显示状态提示
- 保存失败时显示错误信息

### 4. 双向交互

#### 4.1 点击定位（PDF -> Editor）
作为用户，我希望点击 PDF 上的某个区域，编辑器自动滚动到对应段落。

**验收标准：**
- 点击 PDF 上的 Bounding Box
- 编辑器滚动到对应的 Markdown 段落
- 对应段落高亮显示 2 秒
- 光标定位到段落开头

#### 4.2 点击定位（Editor -> PDF）
作为用户，我希望点击编辑器中的某个段落，PDF 自动滚动到对应区域。

**验收标准：**
- 点击编辑器中的段落
- PDF 滚动到对应的 Bounding Box 位置
- 对应 Box 高亮显示 2 秒

#### 4.3 同步滚动（可选，V2）
作为用户，我希望左右两侧能同步滚动，保持视觉对齐。

**验收标准：**
- 滚动 PDF 时，编辑器同步滚动到对应位置
- 滚动编辑器时，PDF 同步滚动到对应位置
- 同步基于 Block 锚点而非百分比
- 可通过开关禁用同步滚动

### 5. 数据流转

#### 5.1 Block ID 映射
作为系统，需要建立 Markdown 段落与 JSON Block 的映射关系。

**验收标准：**
- 后端在 Markdown 中注入不可见锚点 `<div id="block_xxx">`
- 前端能解析锚点获取 Block ID
- Block ID 与 layout.json 中的坐标一一对应

#### 5.2 修正内容回写
作为系统，需要将用户修正后的内容保存并更新向量库。

**验收标准：**
- 调用 `/api/convert/{jobId}/save-markdown` 保存内容
- 保存后自动触发向量库更新
- 返回保存状态和更新时间

## 非功能需求

### 性能要求
- PDF 渲染首屏时间 < 2 秒
- 编辑器输入响应延迟 < 50ms
- 点击定位响应时间 < 200ms

### 兼容性要求
- 支持 Chrome 90+、Edge 90+、Firefox 88+
- 支持 1920x1080 及以上分辨率
- 支持触摸屏操作（平板）

### 可访问性要求
- 支持键盘导航
- 支持屏幕阅读器
- 颜色对比度符合 WCAG 2.1 AA 标准

## 技术约束

- 前端框架：React 18+
- PDF 渲染：react-pdf 或 react-pdf-highlighter-extended
- Markdown 编辑器：Vditor（通过 react-vditor 封装）
- 状态管理：Zustand
- 构建工具：Vite
- 与现有原生 JS 前端共存，通过路由隔离

## 参考文档

- #[[file:MDFiles/implementation/基于 React 与 Markdown 的 OCR 修正与私有化 RAG 架构方案.md]]
- #[[file:MDFiles/implementation/REACT_MARKDOWN_WORKBENCH_FEASIBILITY_ANALYSIS.md]]
