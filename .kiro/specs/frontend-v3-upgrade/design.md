# å‰ç«¯ V3 å‡çº§è®¾è®¡æ–‡æ¡£

> **çŠ¶æ€**: âœ… å·²å®Œæˆï¼ˆ91 é¡¹ä»»åŠ¡å…¨éƒ¨å®Œæˆï¼‰
> **æœ€åæ›´æ–°**: 2026-01-27

## 0. æœ€æ–°åŠŸèƒ½ï¼šå•æ®ç±»å‹é…ç½®

### 0.1 åŠŸèƒ½æ¦‚è¿°

å•æ®ç±»å‹é…ç½®åŠŸèƒ½å…è®¸ç”¨æˆ·åœ¨ä¸Šä¼ æ–‡ä»¶å‰é€‰æ‹©å•æ®ç±»å‹ï¼Œæ­¥éª¤5ä¼šè‡ªåŠ¨åŠ è½½å¯¹åº”çš„å…³é”®è¯æ¨¡æ¿å’Œæ£€æŸ¥ç‚¹é—®é¢˜ã€‚

### 0.2 æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å•æ®ç±»å‹é…ç½®æµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  æ­¥éª¤2ï¼šä¸Šä¼ æ–‡ä»¶                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“‹ å•æ®ç±»å‹ï¼š[å‘ç¥¨ â–¼]  [âš™ï¸ è®¾å®š]                            â”‚   â”‚
â”‚  â”‚  ğŸ“„ æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ ...                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                      â”‚
â”‚                              â–¼ document_type_id ä¿å­˜åˆ° Job ç¼“å­˜     â”‚
â”‚                                                                     â”‚
â”‚  æ­¥éª¤5ï¼šæ•°æ®æå–                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  è‡ªåŠ¨åŠ è½½å•æ®ç±»å‹å¯¹åº”çš„ï¼š                                     â”‚   â”‚
â”‚  â”‚  â€¢ å…³é”®è¯å­—æ®µï¼ˆfieldsï¼‰                                       â”‚   â”‚
â”‚  â”‚  â€¢ æ£€æŸ¥ç‚¹é—®é¢˜ï¼ˆcheckpointsï¼‰                                  â”‚   â”‚
â”‚  â”‚  è‡ªåŠ¨æ‰§è¡Œæå–å’Œæ£€æŸ¥ç‚¹éªŒè¯                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 0.3 æ–°å¢ API

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° |
|------|------|------|
| `/api/document-types` | GET | è·å–æ‰€æœ‰å•æ®ç±»å‹ |
| `/api/document-types` | POST | åˆ›å»ºæ–°å•æ®ç±»å‹ |
| `/api/document-types/{id}` | PUT | æ›´æ–°å•æ®ç±»å‹ |
| `/api/document-types/{id}` | DELETE | åˆ é™¤å•æ®ç±»å‹ |
| `/api/document-types/reset` | POST | é‡ç½®ä¸ºé»˜è®¤é…ç½® |

### 0.4 æ•°æ®ç»“æ„

```json
// config/document_types.json
{
  "document_types": [
    {
      "id": "invoice",
      "name": "å‘ç¥¨",
      "fields": ["å‘ç¥¨å·ç ", "å‘ç¥¨ä»£ç ", "å¼€ç¥¨æ—¥æœŸ", "é‡‘é¢", "ç¨é¢"],
      "checkpoints": [
        "å‘ç¥¨å·ç æ˜¯å¦å®Œæ•´ï¼Ÿ",
        "é‡‘é¢å’Œç¨é¢æ˜¯å¦åŒ¹é…ï¼Ÿ"
      ]
    }
  ]
}
```

### 0.5 æ–°å¢æ–‡ä»¶

- `backend/api/document_type_routes.py` - å•æ®ç±»å‹ API
- `frontend/src/components/DocumentTypeConfig.js` - å•æ®è®¾å®šå¼¹çª—ç»„ä»¶

---

## 1. æ¶æ„æ¦‚è¿°

### 1.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         index.html (ç²¾ç®€ç‰ˆ)                          â”‚
â”‚  - åŸºç¡€ HTML ç»“æ„                                                    â”‚
â”‚  - å¼•å…¥ CSS å’Œ JS æ¨¡å—                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                           â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  styles/      â”‚         â”‚    index.js     â”‚         â”‚  components/  â”‚
â”‚  â”œâ”€ base.css  â”‚         â”‚  (App ä¸»æ§åˆ¶å™¨) â”‚         â”‚  (æ­¥éª¤ç»„ä»¶)   â”‚
â”‚  â”œâ”€ layout.cssâ”‚         â”‚  - å·¥ä½œæµç®¡ç†   â”‚         â”‚               â”‚
â”‚  â”œâ”€ steps.css â”‚         â”‚  - æ­¥éª¤åˆ‡æ¢     â”‚         â”‚               â”‚
â”‚  â””â”€ panels.cssâ”‚         â”‚  - å…¨å±€çŠ¶æ€     â”‚         â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                          â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  StepManager.js   â”‚    â”‚  StateManager.js  â”‚    â”‚  EventBus.js      â”‚
â”‚  - æ­¥éª¤çŠ¶æ€ç®¡ç†   â”‚    â”‚  - å…¨å±€çŠ¶æ€å­˜å‚¨   â”‚    â”‚  - ç»„ä»¶é—´é€šä¿¡     â”‚
â”‚  - æ­¥éª¤åˆ‡æ¢é€»è¾‘   â”‚    â”‚  - æ•°æ®ä¼ é€’       â”‚    â”‚  - äº‹ä»¶å‘å¸ƒè®¢é˜…   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ­¥éª¤ç»„ä»¶æ¶æ„

```
components/steps/
â”œâ”€â”€ Step1ModelLoad.js      # æ­¥éª¤1ï¼šæ¨¡å‹åŠ è½½
â”œâ”€â”€ Step2FileUpload.js     # æ­¥éª¤2ï¼šæ–‡ä»¶ä¸Šä¼ 
â”œâ”€â”€ Step3Recognition.js    # æ­¥éª¤3ï¼šæ™ºèƒ½è¯†åˆ«
â”œâ”€â”€ Step4PreEntry.js       # æ­¥éª¤4ï¼šé¢„å½•å…¥ï¼ˆå¢å¼ºï¼‰
â”œâ”€â”€ Step5DataExtract.js    # æ­¥éª¤5ï¼šæ•°æ®æå–ä¸è‡ªæ£€
â””â”€â”€ Step6Confirmation.js   # æ­¥éª¤6ï¼šè´¢åŠ¡ç¡®è®¤ï¼ˆæ–°å¢ï¼‰

components/panels/
â”œâ”€â”€ HistoryPanel.js        # å†å²ç¼“å­˜é¢æ¿
â”œâ”€â”€ TemplatePanel.js       # å…³é”®è¯æ¨¡æ¿é¢æ¿
â””â”€â”€ CheckpointPanel.js     # æ£€æŸ¥ç‚¹è®¾å®šé¢æ¿
```

### 1.3 æ•°æ®æµ

```
Step3 (OCRç»“æœ)
    â”‚
    â–¼ ocrResult
Step4 (é¢„å½•å…¥)
    â”‚ ç”¨æˆ·ä¿®æ­£
    â–¼ corrections + finalText
Step5 (æ•°æ®æå–)
    â”‚ LLMæå– + æ£€æŸ¥ç‚¹éªŒè¯
    â–¼ extractedData + checkpointResults
Step6 (è´¢åŠ¡ç¡®è®¤)
    â”‚ ç”¨æˆ·ç¡®è®¤/é©³å›
    â–¼ finalResult
```

---

## 2. ç»„ä»¶è®¾è®¡

### 2.1 StepManagerï¼ˆæ­¥éª¤ç®¡ç†å™¨ï¼‰

```javascript
// services/StepManager.js
class StepManager {
    constructor() {
        this.currentStep = 1;
        this.stepStatus = {
            1: 'pending',  // pending | in_progress | completed | error
            2: 'pending',
            3: 'pending',
            4: 'pending',
            5: 'pending',
            6: 'pending'
        };
        this.stepTimings = {};  // æ¯æ­¥è€—æ—¶è®°å½•
    }

    // åˆ‡æ¢åˆ°æŒ‡å®šæ­¥éª¤
    goToStep(stepNumber) {}
    
    // å®Œæˆå½“å‰æ­¥éª¤ï¼Œè¿›å…¥ä¸‹ä¸€æ­¥
    completeCurrentStep() {}
    
    // è¿”å›ä¸Šä¸€æ­¥ï¼ˆä»…æ­¥éª¤6å¯è¿”å›æ­¥éª¤4ï¼‰
    goBack() {}
    
    // æ›´æ–°æ­¥éª¤çŠ¶æ€
    updateStepStatus(step, status) {}
    
    // æ¸²æŸ“æ­¥éª¤è¿›åº¦æ¡
    renderProgressBar() {}
}
```

### 2.2 StateManagerï¼ˆçŠ¶æ€ç®¡ç†å™¨ï¼‰

```javascript
// services/StateManager.js
class StateManager {
    constructor() {
        this.state = {
            jobId: null,
            ocrResult: null,       // æ­¥éª¤3è¾“å‡º
            corrections: [],       // æ­¥éª¤4ç”¨æˆ·ä¿®æ­£
            finalText: null,       // æ­¥éª¤4è¾“å‡ºï¼ˆä¿®æ­£åæ–‡æœ¬ï¼‰
            extractedData: null,   // æ­¥éª¤5æå–ç»“æœ
            checkpointResults: [], // æ­¥éª¤5æ£€æŸ¥ç‚¹ç»“æœ
            finalResult: null      // æ­¥éª¤6æœ€ç»ˆç»“æœ
        };
    }

    // è·å–çŠ¶æ€
    get(key) {}
    
    // è®¾ç½®çŠ¶æ€
    set(key, value) {}
    
    // é‡ç½®çŠ¶æ€ï¼ˆæ–°ä»»åŠ¡æ—¶ï¼‰
    reset() {}
    
    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    persist() {}
    
    // ä»æœ¬åœ°å­˜å‚¨æ¢å¤
    restore() {}
}
```

### 2.3 EventBusï¼ˆäº‹ä»¶æ€»çº¿ï¼‰

```javascript
// services/EventBus.js
class EventBus {
    constructor() {
        this.listeners = {};
    }

    // è®¢é˜…äº‹ä»¶
    on(event, callback) {}
    
    // å–æ¶ˆè®¢é˜…
    off(event, callback) {}
    
    // å‘å¸ƒäº‹ä»¶
    emit(event, data) {}
}

// é¢„å®šä¹‰äº‹ä»¶
const EVENTS = {
    STEP_CHANGED: 'step:changed',
    OCR_COMPLETED: 'ocr:completed',
    CORRECTION_SAVED: 'correction:saved',
    EXTRACTION_COMPLETED: 'extraction:completed',
    CHECKPOINT_COMPLETED: 'checkpoint:completed',
    FINAL_CONFIRMED: 'final:confirmed',
    FINAL_REJECTED: 'final:rejected'
};
```

---

## 3. æ­¥éª¤ç»„ä»¶è¯¦ç»†è®¾è®¡

### 3.1 Step4PreEntryï¼ˆé¢„å½•å…¥ç»„ä»¶ï¼‰

```javascript
// components/steps/Step4PreEntry.js
class Step4PreEntry {
    constructor(container, stateManager, eventBus) {
        this.container = container;
        this.state = stateManager;
        this.events = eventBus;
        this.corrections = [];
    }

    // æ¸²æŸ“ç•Œé¢
    render() {
        // å·¦ä¾§ï¼šåŸå§‹å›¾ç‰‡ + OCRåŒºåŸŸæ¡†
        // å³ä¾§ï¼šBlockåˆ—è¡¨ï¼ˆå¯ç¼–è¾‘ï¼‰
    }

    // ç¼–è¾‘Block
    editBlock(blockIndex) {
        // å¼¹å‡ºç¼–è¾‘æ¡†
        // è®°å½•åŸå§‹å€¼
    }

    // ä¿å­˜ä¿®æ­£
    async saveCorrection(blockIndex, originalText, correctedText) {
        const correction = {
            blockIndex,
            originalText,
            correctedText,
            timestamp: new Date().toISOString()
        };
        this.corrections.push(correction);
        
        // ä¿å­˜åˆ°åç«¯
        await this.saveCorrectionToBackend(correction);
        
        // å‘å¸ƒäº‹ä»¶
        this.events.emit(EVENTS.CORRECTION_SAVED, correction);
    }

    // ä¿å­˜åˆ°åç«¯
    async saveCorrectionToBackend(correction) {
        const jobId = this.state.get('jobId');
        await fetch(`/api/corrections/${jobId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(correction)
        });
    }

    // ç¡®è®¤å¹¶è¿›å…¥ä¸‹ä¸€æ­¥
    confirmAndProceed() {
        // åˆå¹¶ä¿®æ­£åçš„æ–‡æœ¬
        const finalText = this.mergeCorrectedText();
        this.state.set('finalText', finalText);
        this.state.set('corrections', this.corrections);
        
        // è§¦å‘æ­¥éª¤å®Œæˆ
        this.events.emit(EVENTS.STEP_COMPLETED, { step: 4 });
    }
}
```

### 3.2 Step5DataExtractï¼ˆæ•°æ®æå–ç»„ä»¶ï¼‰

```javascript
// components/steps/Step5DataExtract.js
class Step5DataExtract {
    constructor(container, stateManager, eventBus) {
        this.container = container;
        this.state = stateManager;
        this.events = eventBus;
    }

    // æ¸²æŸ“ç•Œé¢
    render() {
        // æ¨¡æ¿é€‰æ‹©åŒº
        // æå–ç»“æœæ˜¾ç¤ºåŒº
        // æ£€æŸ¥ç‚¹ç»“æœæ˜¾ç¤ºåŒº
    }

    // æ‰§è¡Œå…³é”®è¯æå–
    async extractByTemplate(templateId) {
        const finalText = this.state.get('finalText');
        const template = await this.loadTemplate(templateId);
        
        const response = await fetch('/api/llm/extract', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                text: finalText,
                fields: template.fields
            })
        });
        
        const extractedData = await response.json();
        this.state.set('extractedData', extractedData);
        this.renderExtractedData(extractedData);
        
        this.events.emit(EVENTS.EXTRACTION_COMPLETED, extractedData);
    }

    // æ‰§è¡Œæ£€æŸ¥ç‚¹éªŒè¯
    async runCheckpoints() {
        const checkpoints = await this.loadCheckpoints();
        const finalText = this.state.get('finalText');
        const results = [];
        
        for (const checkpoint of checkpoints) {
            const response = await fetch('/api/llm/qa', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    question: checkpoint.question,
                    context: finalText
                })
            });
            
            const result = await response.json();
            results.push({
                question: checkpoint.question,
                answer: result.answer,
                confidence: result.confidence
            });
        }
        
        this.state.set('checkpointResults', results);
        this.renderCheckpointResults(results);
        
        // ä¿å­˜åˆ°åç«¯
        await this.saveCheckpointsToBackend(results);
        
        this.events.emit(EVENTS.CHECKPOINT_COMPLETED, results);
    }

    // ä¿å­˜æ£€æŸ¥ç‚¹ç»“æœåˆ°åç«¯
    async saveCheckpointsToBackend(results) {
        const jobId = this.state.get('jobId');
        await fetch(`/api/checkpoints/${jobId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(results)
        });
    }
}
```

### 3.3 Step6Confirmationï¼ˆè´¢åŠ¡ç¡®è®¤ç»„ä»¶ï¼‰

```javascript
// components/steps/Step6Confirmation.js
class Step6Confirmation {
    constructor(container, stateManager, eventBus) {
        this.container = container;
        this.state = stateManager;
        this.events = eventBus;
    }

    // æ¸²æŸ“ç•Œé¢
    render() {
        const checkpointResults = this.state.get('checkpointResults');
        const extractedData = this.state.get('extractedData');
        
        this.container.innerHTML = `
            <div class="confirmation-panel">
                <div class="checkpoint-section">
                    <h3>æ£€æŸ¥ç‚¹éªŒè¯ç»“æœ</h3>
                    ${this.renderCheckpointList(checkpointResults)}
                </div>
                <div class="data-section">
                    <h3>æå–æ•°æ®</h3>
                    <div class="json-viewer">
                        <pre>${JSON.stringify(extractedData, null, 2)}</pre>
                    </div>
                    <button class="copy-btn">å¤åˆ¶ JSON</button>
                </div>
                <div class="action-buttons">
                    <button class="confirm-btn">ç¡®è®¤</button>
                    <button class="reject-btn">é©³å›</button>
                </div>
            </div>
        `;
        
        this.bindEvents();
    }

    // ç¡®è®¤
    async confirm() {
        const finalResult = {
            jobId: this.state.get('jobId'),
            extractedData: this.state.get('extractedData'),
            checkpointResults: this.state.get('checkpointResults'),
            corrections: this.state.get('corrections'),
            status: 'confirmed',
            confirmedAt: new Date().toISOString()
        };
        
        await this.saveFinalResult(finalResult);
        this.events.emit(EVENTS.FINAL_CONFIRMED, finalResult);
    }

    // é©³å›ï¼ˆè¿”å›æ­¥éª¤4ï¼‰
    reject() {
        this.events.emit(EVENTS.FINAL_REJECTED);
        // StepManager ç›‘å¬æ­¤äº‹ä»¶ï¼Œè·³è½¬åˆ°æ­¥éª¤4
    }
}
```

---

## 4. åç«¯ API è®¾è®¡

### 4.1 æ–°å¢ API ç«¯ç‚¹

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° |
|------|------|------|
| `/api/corrections/{job_id}` | POST | ä¿å­˜ç”¨æˆ·ä¿®æ­£è®°å½• |
| `/api/corrections/{job_id}` | GET | è·å–ä¿®æ­£è®°å½• |
| `/api/checkpoints/{job_id}` | POST | ä¿å­˜æ£€æŸ¥ç‚¹ç»“æœ |
| `/api/checkpoints/{job_id}` | GET | è·å–æ£€æŸ¥ç‚¹ç»“æœ |
| `/api/final/{job_id}` | POST | ä¿å­˜æœ€ç»ˆç¡®è®¤ç»“æœ |
| `/api/final/{job_id}` | GET | è·å–æœ€ç»ˆç»“æœ |
| `/api/templates` | GET | è·å–å…³é”®è¯æ¨¡æ¿åˆ—è¡¨ |
| `/api/templates` | POST | åˆ›å»ºæ–°æ¨¡æ¿ |
| `/api/templates/{id}` | PUT | æ›´æ–°æ¨¡æ¿ |
| `/api/templates/{id}` | DELETE | åˆ é™¤æ¨¡æ¿ |
| `/api/checkpoint-config` | GET | è·å–æ£€æŸ¥ç‚¹é…ç½® |
| `/api/checkpoint-config` | POST | ä¿å­˜æ£€æŸ¥ç‚¹é…ç½® |

### 4.2 æ•°æ®å­˜å‚¨æ ¼å¼

```python
# temp/{job_id}_corrections.json
{
    "job_id": "uuid",
    "corrections": [
        {
            "block_index": 0,
            "original_text": "åŸå§‹æ–‡æœ¬",
            "corrected_text": "ä¿®æ­£åæ–‡æœ¬",
            "timestamp": "2026-01-26T10:30:00Z"
        }
    ]
}

# temp/{job_id}_checkpoints.json
{
    "job_id": "uuid",
    "results": [
        {
            "question": "å‘ç¥¨é‡‘é¢æ˜¯å¤šå°‘ï¼Ÿ",
            "answer": "Â¥1,234.56",
            "confidence": 0.95
        }
    ],
    "executed_at": "2026-01-26T10:35:00Z"
}

# temp/{job_id}_final_result.json
{
    "job_id": "uuid",
    "extracted_data": { ... },
    "checkpoint_results": [ ... ],
    "corrections": [ ... ],
    "status": "confirmed",  // confirmed | rejected
    "confirmed_at": "2026-01-26T10:40:00Z"
}
```

---

## 5. æ–‡ä»¶ç»“æ„é‡æ„

### 5.1 ç›®æ ‡ç»“æ„

```
frontend/src/
â”œâ”€â”€ index.html              # ç²¾ç®€ç‰ˆï¼ˆ~200è¡Œï¼‰
â”œâ”€â”€ index.js                # App å…¥å£ï¼ˆ~150è¡Œï¼‰
â”œâ”€â”€ styles/
â”‚   â”œâ”€â”€ base.css            # åŸºç¡€æ ·å¼ã€å˜é‡
â”‚   â”œâ”€â”€ layout.css          # å¸ƒå±€æ ·å¼
â”‚   â”œâ”€â”€ steps.css           # æ­¥éª¤è¿›åº¦æ¡æ ·å¼
â”‚   â”œâ”€â”€ panels.css          # é¢æ¿æ ·å¼
â”‚   â””â”€â”€ components.css      # ç»„ä»¶æ ·å¼
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ APIClient.js        # API å®¢æˆ·ç«¯ï¼ˆä¿ç•™ï¼‰
â”‚   â”œâ”€â”€ StepManager.js      # æ­¥éª¤ç®¡ç†å™¨ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ StateManager.js     # çŠ¶æ€ç®¡ç†å™¨ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ EventBus.js         # äº‹ä»¶æ€»çº¿ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ DocumentProcessor.js # æ–‡æ¡£å¤„ç†ï¼ˆä¿ç•™ï¼‰
â”‚   â”œâ”€â”€ StatusPoller.js     # çŠ¶æ€è½®è¯¢ï¼ˆä¿ç•™ï¼‰
â”‚   â””â”€â”€ UIManager.js        # UI ç®¡ç†ï¼ˆä¿ç•™ï¼‰
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ steps/
â”‚   â”‚   â”œâ”€â”€ Step1ModelLoad.js
â”‚   â”‚   â”œâ”€â”€ Step2FileUpload.js
â”‚   â”‚   â”œâ”€â”€ Step3Recognition.js
â”‚   â”‚   â”œâ”€â”€ Step4PreEntry.js
â”‚   â”‚   â”œâ”€â”€ Step5DataExtract.js
â”‚   â”‚   â””â”€â”€ Step6Confirmation.js
â”‚   â”œâ”€â”€ panels/
â”‚   â”‚   â”œâ”€â”€ HistoryPanel.js
â”‚   â”‚   â”œâ”€â”€ TemplatePanel.js
â”‚   â”‚   â””â”€â”€ CheckpointPanel.js
â”‚   â”œâ”€â”€ ChatOCRIntegration.js  # ä¿ç•™
â”‚   â”œâ”€â”€ DocumentQA.js          # ä¿ç•™
â”‚   â””â”€â”€ SmartExtract.js        # ä¿ç•™
â””â”€â”€ __tests__/
    â””â”€â”€ ...
```

### 5.2 CSS æŠ½å–è§„åˆ’

| åŸä½ç½® | ç›®æ ‡æ–‡ä»¶ | å†…å®¹ |
|--------|----------|------|
| index.html `:root` | base.css | CSS å˜é‡ã€é‡ç½®æ ·å¼ |
| index.html `.container` | layout.css | ä¸»å¸ƒå±€ã€ç½‘æ ¼ |
| index.html `.step-*` | steps.css | æ­¥éª¤è¿›åº¦æ¡ |
| index.html `.panel-*` | panels.css | ä¾§è¾¹é¢æ¿ |
| index.html `.block-*` | components.css | Block ç»„ä»¶ |

---

## 6. æ­£ç¡®æ€§å±æ€§

### 6.1 æ­¥éª¤æµè½¬å±æ€§

```
P1: æ­¥éª¤å¿…é¡»æŒ‰é¡ºåºå®Œæˆ
    âˆ€ step âˆˆ [2,6]: canEnter(step) âŸ¹ isCompleted(step-1)

P2: æ­¥éª¤4ä¿®æ­£å¿…é¡»ä¼ é€’åˆ°æ­¥éª¤5
    corrections.saved âŸ¹ step5.input.contains(corrections)

P3: æ­¥éª¤6é©³å›å¿…é¡»è¿”å›æ­¥éª¤4
    step6.rejected âŸ¹ currentStep = 4
```

### 6.2 æ•°æ®å®Œæ•´æ€§å±æ€§

```
P4: ä¿®æ­£è®°å½•å¿…é¡»åŒ…å«å®Œæ•´ä¿¡æ¯
    âˆ€ correction: correction.blockIndex â‰  null 
                  âˆ§ correction.originalText â‰  null
                  âˆ§ correction.correctedText â‰  null
                  âˆ§ correction.timestamp â‰  null

P5: æœ€ç»ˆç»“æœå¿…é¡»åŒ…å«æ‰€æœ‰å¿…è¦æ•°æ®
    finalResult.confirmed âŸ¹ 
        finalResult.extractedData â‰  null
        âˆ§ finalResult.checkpointResults â‰  null
```

### 6.3 UI çŠ¶æ€å±æ€§

```
P6: å½“å‰æ­¥éª¤å¿…é¡»é«˜äº®æ˜¾ç¤º
    âˆ€ step: step = currentStep âŸ¹ step.isHighlighted

P7: æœªå®Œæˆæ­¥éª¤ä¸å¯ç‚¹å‡»
    âˆ€ step: Â¬isCompleted(step-1) âŸ¹ Â¬step.isClickable
```

---

## 7. æµ‹è¯•ç­–ç•¥

### 7.1 å•å…ƒæµ‹è¯•

| ç»„ä»¶ | æµ‹è¯•é‡ç‚¹ |
|------|----------|
| StepManager | æ­¥éª¤åˆ‡æ¢é€»è¾‘ã€çŠ¶æ€æ›´æ–° |
| StateManager | çŠ¶æ€å­˜å–ã€æŒä¹…åŒ– |
| EventBus | äº‹ä»¶å‘å¸ƒè®¢é˜… |
| Step4PreEntry | ä¿®æ­£ä¿å­˜ã€æ–‡æœ¬åˆå¹¶ |
| Step5DataExtract | æ¨¡æ¿æå–ã€æ£€æŸ¥ç‚¹æ‰§è¡Œ |
| Step6Confirmation | ç¡®è®¤/é©³å›é€»è¾‘ |

### 7.2 é›†æˆæµ‹è¯•

| åœºæ™¯ | æµ‹è¯•å†…å®¹ |
|------|----------|
| å®Œæ•´å·¥ä½œæµ | æ­¥éª¤1-6é¡ºåºæ‰§è¡Œ |
| ä¿®æ­£ä¼ é€’ | æ­¥éª¤4ä¿®æ­£åœ¨æ­¥éª¤5å¯è§ |
| é©³å›æµç¨‹ | æ­¥éª¤6é©³å›è¿”å›æ­¥éª¤4 |
| æ•°æ®æŒä¹…åŒ– | åˆ·æ–°é¡µé¢åæ•°æ®æ¢å¤ |

---

## 8. è¿ç§»ç­–ç•¥

### 8.1 é˜¶æ®µä¸€ï¼šåŸºç¡€é‡æ„ï¼ˆä¸å½±å“åŠŸèƒ½ï¼‰

1. æŠ½å– CSS åˆ°ç‹¬ç«‹æ–‡ä»¶
2. åˆ›å»º StepManagerã€StateManagerã€EventBus
3. ä¿æŒç°æœ‰åŠŸèƒ½ä¸å˜

### 8.2 é˜¶æ®µäºŒï¼šæ­¥éª¤ç»„ä»¶åŒ–

1. åˆ›å»º Step1-3 ç»„ä»¶ï¼ˆå°è£…ç°æœ‰é€»è¾‘ï¼‰
2. åˆ›å»º Step4 å¢å¼ºç»„ä»¶
3. åˆ›å»º Step5 å¢å¼ºç»„ä»¶
4. åˆ›å»º Step6 æ–°ç»„ä»¶

### 8.3 é˜¶æ®µä¸‰ï¼šé¢æ¿ç»„ä»¶åŒ–

1. åˆ›å»º HistoryPanel
2. åˆ›å»º TemplatePanel
3. åˆ›å»º CheckpointPanel

### 8.4 é˜¶æ®µå››ï¼šåç«¯ API

1. å®ç°ä¿®æ­£è®°å½• API
2. å®ç°æ£€æŸ¥ç‚¹ API
3. å®ç°æœ€ç»ˆç»“æœ API
4. å®ç°æ¨¡æ¿ç®¡ç† API
