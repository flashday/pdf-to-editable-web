# 单据设定功能开发计划

> 创建时间：2026-01-27
> 状态：待实现

---

## 📊 需求来源

根据用户提供的流程图，需要在现有6步流程基础上增加"单据设定"功能。

---

## 🔄 目标流程

```
┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐
│ 单据设定  │ → │ 1模型加载 │ → │ 2上传文件 │ → │ 3智能识别 │ → │ 4预录入   │ → │ 5数据提取 │ → │ 6财务确认 │
└──────────┘   └──────────┘   └──────────┘   └──────────┘   └──────────┘   └──────────┘   └──────────┘
     │                              │                              │              │
     │                              │                              │              │
     ▼                              ▼                              ▼              ▼
  弹出界面                      选择单据类型                    左图右Block      根据单据类型
  1)定义单据类型                并上传PDF                      模式编辑         自动加载模板
  2)对单据类型定义                                                             和检查点
    关键词模板
  3)对单据类型定义
    检查点问题
```

---

## 📁 当前前端结构

```
frontend/src/
├── index.html              # 主页面入口
├── index.js                # 主应用逻辑
├── components/
│   ├── steps/              # 步骤组件（6步流程）
│   │   ├── Step1ModelLoad.js
│   │   ├── Step2FileUpload.js
│   │   ├── Step3Recognition.js
│   │   ├── Step4PreEntry.js
│   │   ├── Step5DataExtract.js
│   │   └── Step6Confirmation.js
│   ├── panels/             # 面板组件
│   │   ├── CheckpointPanel.js
│   │   ├── HistoryPanel.js
│   │   └── TemplatePanel.js
│   ├── ChatOCRIntegration.js   # 智能功能集成
│   ├── SmartExtract.js         # 智能提取面板
│   └── DocumentQA.js           # 文档问答面板
├── services/               # 服务层
│   ├── StateManager.js
│   ├── EventBus.js
│   ├── StepManager.js
│   └── ...
├── styles/                 # 样式
└── utils/
    └── globalFunctions.js
```

---

## 📋 改动评估

### 当前实现 vs 目标需求对比

| 步骤 | 当前实现 | 目标需求 | 状态 |
|------|----------|----------|------|
| **单据设定** | ❌ 无 | 弹出界面：定义单据类型、关键词模板、检查点 | **新增** |
| **步骤1** | ✅ 模型加载（OCR/LLM/RAG状态检测） | 模型加载完成后自动切换步骤2 | ✅ 已实现 |
| **步骤2** | ✅ 上传文件 | 选择单据类型 + 上传PDF | **需修改** |
| **步骤3** | ✅ 智能识别（PPStructure） | 后台识别，界面显示进度 | ✅ 已实现 |
| **步骤4** | ✅ 预录入（左图右Block） | 左图右Block，保留MD切换 | ✅ 已实现 |
| **步骤5** | ✅ 数据提取+检查点 | 根据单据类型设定的模板和检查点 | **需修改** |
| **步骤6** | ✅ 财务确认 | 检查点问答上半部，JSON下半部 | ✅ 已实现 |
| **缓存** | ✅ 历史缓存面板 | 弹出界面查看历史缓存 | ✅ 已实现 |

---

## 🔴 待实现改动项

### 1. 新增：单据设定弹窗（工作量：中）

**新建文件**：`frontend/src/components/DocumentTypeConfig.js`

**功能**：
- 定义单据类型（发票、合同、收据、自定义等）
- 对每种单据类型定义关键词提取模板
- 对每种单据类型定义检查点问题
- 数据持久化到后端/本地存储

**UI设计**：
```
┌─────────────────────────────────────────────────────────┐
│  📋 单据设定                                      [✕]  │
├─────────────────────────────────────────────────────────┤
│  单据类型列表：                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ [+新增] [发票] [合同] [收据] [身份证] [自定义]   │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  当前选中：发票                                         │
│  ─────────────────────────────────────────────────────  │
│  关键词模板：                                           │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 发票号码                                         │   │
│  │ 发票代码                                         │   │
│  │ 开票日期                                         │   │
│  │ 金额                                             │   │
│  │ [+添加字段]                                      │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  检查点问题：                                           │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 1. 发票号码是多少？                              │   │
│  │ 2. 开票日期是什么？                              │   │
│  │ 3. 金额合计是多少？                              │   │
│  │ [+添加检查点]                                    │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│              [取消]  [保存]                              │
└─────────────────────────────────────────────────────────┘
```

---

### 2. 修改：步骤2增加单据类型选择（工作量：小）

**修改文件**：`frontend/src/index.html`, `frontend/src/index.js`

**功能**：
- 上传区域增加单据类型下拉选择
- 选择的单据类型存入 StateManager
- 单据类型决定后续步骤5使用的模板和检查点

**UI变化**：
```
┌─────────────────────────────────────────────────────────┐
│  上传区域                                               │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 单据类型：[发票 ▼]  [⚙️ 设定]                    │   │
│  │                                                   │   │
│  │ 📄 拖拽 PDF、JPG 或 PNG 文件到此处，或点击选择   │   │
│  │                                                   │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

---

### 3. 修改：步骤5关联单据设定（工作量：小）

**修改文件**：`frontend/src/components/steps/Step5DataExtract.js`

**功能**：
- 根据步骤2选择的单据类型，自动加载对应的模板
- 自动加载对应的检查点问题
- 不再需要用户手动选择模板（但保留手动修改能力）

---

### 4. 后端：单据类型配置API（工作量：小）

**新建/修改文件**：`backend/api/document_type_routes.py`

**API设计**：
```
GET  /api/document-types          # 获取所有单据类型配置
POST /api/document-types          # 创建新单据类型
PUT  /api/document-types/{id}     # 更新单据类型
DELETE /api/document-types/{id}   # 删除单据类型
```

**数据结构**：
```json
{
  "id": "invoice",
  "name": "发票",
  "fields": ["发票号码", "发票代码", "开票日期", "金额", "税额"],
  "checkpoints": [
    "发票号码是多少？",
    "开票日期是什么？",
    "金额合计是多少？"
  ],
  "created_at": "2026-01-27T10:00:00Z",
  "updated_at": "2026-01-27T10:00:00Z"
}
```

---

## 📈 工作量估算

| 改动项 | 文件 | 工作量 | 预计时间 |
|--------|------|--------|----------|
| 新增单据设定弹窗 | 新建 `DocumentTypeConfig.js` | 中 | 1-2小时 |
| 步骤2增加单据类型选择 | `index.html`, `index.js` | 小 | 30分钟 |
| 步骤5关联单据设定 | `Step5DataExtract.js` | 小 | 30分钟 |
| 后端单据类型配置API | `backend/api/` | 小 | 30分钟 |

**总计：约 2.5-3.5 小时**

---

## ✅ 已满足的需求

- [x] 步骤1：模型加载
- [x] 步骤3：智能识别
- [x] 步骤4：预录入（左图右Block，保留MD切换）
- [x] 步骤6：财务确认（检查点+JSON）
- [x] 历史缓存面板
- [x] 各步骤界面独立切换

---

## 📝 实施顺序建议

1. **后端API** - 先建立数据存储基础
2. **单据设定弹窗** - 核心功能
3. **步骤2单据类型选择** - 入口
4. **步骤5关联** - 串联整个流程

---

## 🔗 相关文件

- `config/templates.json` - 现有模板配置
- `frontend/src/components/panels/TemplatePanel.js` - 现有模板面板
- `frontend/src/components/panels/CheckpointPanel.js` - 现有检查点面板
